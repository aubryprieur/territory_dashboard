<div class="bg-white shadow rounded-lg p-6 mb-6">
  <h2 class="text-lg font-medium text-gray-900 mb-4">Familles</h2>
  <h3 class="text-md font-medium text-gray-800 mb-4 mt-8">Couples avec enfant(s)</h3>

  <!-- Nouveau tableau de comparaison √† ajouter ici -->
  <!-- Tableau de comparaison -->
  <div class="mb-6">
    <h4 class="text-sm font-medium text-gray-700 mb-2">Comparaison territoriale (<%= @epci_family_data&.dig("family_data")&.keys&.sort&.last || @epci_families_data&.dig("year") %>)</h4>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              √âchelon territorial
            </th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Taux de couples avec enfants
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <!-- EPCI -->
          <tr>
            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
              <%= display_territory_name(epci_display_name) %>
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
              <div class="flex items-center">
                <%
                  epci_rate = @epci_families_data.present? ?
                    @epci_families_data["epci_couples_with_children_percentage"] :
                    @epci_family_data&.dig("family_data", @epci_family_data&.dig("family_data")&.keys&.sort&.last, "couples_with_children_percentage")
                %>
                <span class="<%= epci_rate && epci_rate > 0 ? "font-semibold" : "" %>">
                  <%= number_to_percentage(epci_rate, precision: 2) %>
                </span>
                <% if epci_rate && epci_rate > 0 %>
                  <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                    <div class="bg-indigo-600 h-2 rounded-full" style="width: <%= [epci_rate * 100 / 50, 100].min %>%"></div>
                  </div>
                <% end %>
              </div>
            </td>
          </tr>

          <!-- D√©partement -->
          <% if @department_family_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <%= department_display_name %>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <div class="flex items-center">
                  <%
                    latest_year = @department_family_data&.dig("family_data")&.keys&.sort&.last
                    dept_rate = latest_year ? @department_family_data&.dig("family_data", latest_year, "couples_with_children_percentage") : nil
                  %>
                  <span class="<%= dept_rate && dept_rate > 0 ? "font-semibold" : "" %>">
                    <%= number_to_percentage(dept_rate, precision: 2) %>
                  </span>
                  <% if dept_rate && dept_rate > 0 %>
                    <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                      <div class="bg-blue-600 h-2 rounded-full" style="width: <%= [dept_rate * 100 / 50, 100].min %>%"></div>
                    </div>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>

          <!-- R√©gion -->
          <% if @region_family_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <%= region_display_name %>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <div class="flex items-center">
                  <%
                    latest_year = @region_family_data&.dig("family_data")&.keys&.sort&.last
                    region_rate = latest_year ? @region_family_data&.dig("family_data", latest_year, "couples_with_children_percentage") : nil
                  %>
                  <span class="<%= region_rate && region_rate > 0 ? "font-semibold" : "" %>">
                    <%= number_to_percentage(region_rate, precision: 2) %>
                  </span>
                  <% if region_rate && region_rate > 0 %>
                    <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                      <div class="bg-green-600 h-2 rounded-full" style="width: <%= [region_rate * 100 / 50, 100].min %>%"></div>
                    </div>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>

          <!-- France -->
          <% if @france_family_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                France
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <div class="flex items-center">
                  <%
                    latest_year = @france_family_data&.dig("family_data")&.keys&.sort&.last
                    france_rate = latest_year ? @france_family_data&.dig("family_data", latest_year, "couples_with_children_percentage") : nil
                  %>
                  <span class="<%= france_rate && france_rate > 0 ? "font-semibold" : "" %>">
                    <%= number_to_percentage(france_rate, precision: 2) %>
                  </span>
                  <% if france_rate && france_rate > 0 %>
                    <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                      <div class="bg-red-600 h-2 rounded-full" style="width: <%= [france_rate * 100 / 50, 100].min %>%"></div>
                    </div>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    <div class="mt-2 text-xs text-gray-500">
      <p>Note: Les barres de progression sont calibr√©es pour un maximum de 50%.</p>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Carte des couples avec enfants -->
      <div>
        <h4 class="text-sm font-medium text-gray-700 mb-2">R√©partition des couples avec enfants par commune (<%= @epci_families_data["year"] %>)</h4>
        <div id="communes-map-families" class="h-[500px] w-full border border-gray-200 rounded-md"></div>
        <div id="families-legend" class="mt-3"></div>
      </div>

      <!-- Statistiques de synth√®se -->
      <div>
        <h4 class="text-sm font-medium text-gray-700 mb-2">Statistiques des couples avec enfants</h4>

        <div class="bg-gray-50 p-4 rounded-md mb-4">
          <div class="grid grid-cols-2 gap-4">
            <!-- Pourcentage moyen EPCI -->
            <div class="bg-white p-3 rounded shadow-sm">
              <h5 class="text-sm font-medium text-gray-700 mb-1">Moyenne EPCI</h5>
              <p class="text-xl font-bold text-indigo-600">
                <%= number_to_percentage(@epci_families_data["epci_couples_with_children_percentage"], precision: 2) %>
              </p>
            </div>

            <!-- Nombre total -->
            <div class="bg-white p-3 rounded shadow-sm">
              <h5 class="text-sm font-medium text-gray-700 mb-1">Nombre total</h5>
              <p class="text-xl font-bold text-indigo-600">
                <%= number_with_delimiter(@epci_families_data["total_couples_with_children"].round) %>
              </p>
            </div>
          </div>
        </div>

        <% if @epci_families_data["communes"].present? %>
          <%
            # Calculer quelques statistiques
            communes = @epci_families_data["communes"]
            sorted_communes = communes.sort_by { |c| c["couples_with_children_percentage"] }

            min_commune = sorted_communes.first
            max_commune = sorted_communes.last

            median_index = communes.length / 2
            median_commune = sorted_communes[median_index]
          %>

          <div class="overflow-x-auto mt-4">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Indicateur
                  </th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Commune
                  </th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Taux
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <!-- Commune avec le taux le plus bas -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                    Taux le plus bas
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= min_commune["name"] %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= number_to_percentage(min_commune["couples_with_children_percentage"], precision: 2) %>
                  </td>
                </tr>

                <!-- Commune m√©diane -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                    Valeur m√©diane
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= median_commune["name"] %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= number_to_percentage(median_commune["couples_with_children_percentage"], precision: 2) %>
                  </td>
                </tr>

                <!-- Commune avec le taux le plus √©lev√© -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                    Taux le plus √©lev√©
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= max_commune["name"] %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= number_to_percentage(max_commune["couples_with_children_percentage"], precision: 2) %>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Bo√Æte d'information explicative -->
    <div class="mt-6 bg-gray-50 p-4 rounded-md">
      <h4 class="text-sm font-medium text-gray-700 mb-2">√Ä propos des couples avec enfants</h4>
      <p class="text-sm text-gray-600">
        Cette carte pr√©sente le pourcentage de couples avec enfants parmi l'ensemble des m√©nages de chaque commune.
        Cet indicateur permet d'identifier les communes o√π la proportion de familles est plus importante, ce qui peut
        influencer les politiques en mati√®re de logement, d'√©ducation et de services aux familles.
      </p>
    </div>

    <!-- Nouveau bloc pour les familles monoparentales -->
    <h3 class="text-md font-medium text-gray-800 mb-4 mt-8">Familles monoparentales</h3>

    <!-- Nouveau tableau de comparaison des familles monoparentales -->
    <div class="mb-6">
      <h4 class="text-sm font-medium text-gray-700 mb-2">Comparaison territoriale (<%= @epci_single_parent_data["year"] %>)</h4>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                √âchelon territorial
              </th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Taux de familles monoparentales
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <!-- EPCI -->
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                <%= display_territory_name(epci_display_name) %>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <div class="flex items-center">
                  <% epci_rate = @epci_single_parent_data["epci_single_parent_percentage"] %>
                  <span class="<%= epci_rate && epci_rate > 0 ? "font-semibold" : "" %>">
                    <%= number_to_percentage(epci_rate, precision: 2) %>
                  </span>
                  <% if epci_rate && epci_rate > 0 %>
                    <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                      <div class="bg-purple-600 h-2 rounded-full" style="width: <%= [epci_rate * 100 / 30, 100].min %>%"></div>
                    </div>
                  <% end %>
                </div>
              </td>
            </tr>

            <!-- D√©partement -->
            <% if @department_family_data.present? %>
              <tr>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= department_display_name %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <div class="flex items-center">
                    <%
                      latest_year = @department_family_data&.dig("family_data")&.keys&.sort&.last
                      dept_rate = latest_year ? @department_family_data&.dig("family_data", latest_year, "single_parent_families_percentage") : nil
                    %>
                    <span class="<%= dept_rate && dept_rate > 0 ? "font-semibold" : "" %>">
                      <%= number_to_percentage(dept_rate, precision: 2) %>
                    </span>
                    <% if dept_rate && dept_rate > 0 %>
                      <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: <%= [dept_rate * 100 / 30, 100].min %>%"></div>
                      </div>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>

            <!-- R√©gion -->
            <% if @region_family_data.present? %>
              <tr>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= region_display_name %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <div class="flex items-center">
                    <%
                      latest_year = @region_family_data&.dig("family_data")&.keys&.sort&.last
                      region_rate = latest_year ? @region_family_data&.dig("family_data", latest_year, "single_parent_families_percentage") : nil
                    %>
                    <span class="<%= region_rate && region_rate > 0 ? "font-semibold" : "" %>">
                      <%= number_to_percentage(region_rate, precision: 2) %>
                    </span>
                    <% if region_rate && region_rate > 0 %>
                      <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                        <div class="bg-green-600 h-2 rounded-full" style="width: <%= [region_rate * 100 / 30, 100].min %>%"></div>
                      </div>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>

            <!-- France -->
            <% if @france_family_data.present? %>
              <tr>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                  France
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <div class="flex items-center">
                    <%
                      latest_year = @france_family_data&.dig("family_data")&.keys&.sort&.last
                      france_rate = latest_year ? @france_family_data&.dig("family_data", latest_year, "single_parent_families_percentage") : nil
                    %>
                    <span class="<%= france_rate && france_rate > 0 ? "font-semibold" : "" %>">
                      <%= number_to_percentage(france_rate, precision: 2) %>
                    </span>
                    <% if france_rate && france_rate > 0 %>
                      <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                        <div class="bg-red-600 h-2 rounded-full" style="width: <%= [france_rate * 100 / 30, 100].min %>%"></div>
                      </div>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <div class="mt-2 text-xs text-gray-500">
        <p>Note: Les barres de progression sont calibr√©es pour un maximum de 30%.</p>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Carte des familles monoparentales -->
      <div>
        <h4 class="text-sm font-medium text-gray-700 mb-2">R√©partition des familles monoparentales par commune (<%= @epci_single_parent_data["year"] %>)</h4>
        <div id="communes-map-single-parent" class="h-[500px] w-full border border-gray-200 rounded-md"></div>
        <div id="single-parent-legend" class="mt-3"></div>
      </div>

      <!-- Statistiques de synth√®se des familles monoparentales -->
      <div>
        <h4 class="text-sm font-medium text-gray-700 mb-2">Statistiques des familles monoparentales</h4>

        <div class="bg-gray-50 p-4 rounded-md mb-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Pourcentage moyen EPCI -->
            <div class="bg-white p-3 rounded shadow-sm">
              <h5 class="text-sm font-medium text-gray-700 mb-1">Moyenne EPCI</h5>
              <p class="text-xl font-bold text-purple-600">
                <%= number_to_percentage(@epci_single_parent_data["epci_single_parent_percentage"], precision: 2) %>
              </p>
            </div>

            <!-- R√©partition p√®res/m√®res -->
            <div class="bg-white p-3 rounded shadow-sm">
              <h5 class="text-sm font-medium text-gray-700 mb-1">P√®res seuls</h5>
              <p class="text-xl font-bold text-blue-600">
                <%= number_to_percentage(@epci_single_parent_data["epci_single_father_percentage"], precision: 2) %>
              </p>
            </div>

            <div class="bg-white p-3 rounded shadow-sm">
              <h5 class="text-sm font-medium text-gray-700 mb-1">M√®res seules</h5>
              <p class="text-xl font-bold text-pink-600">
                <%= number_to_percentage(@epci_single_parent_data["epci_single_mother_percentage"], precision: 2) %>
              </p>
            </div>
          </div>
        </div>

        <% if @epci_single_parent_data["communes"].present? %>
          <%
            # Calculer quelques statistiques
            communes = @epci_single_parent_data["communes"]
            sorted_communes = communes.sort_by { |c| c["single_parent_percentage"] }

            min_commune = sorted_communes.first
            max_commune = sorted_communes.last

            median_index = communes.length / 2
            median_commune = sorted_communes[median_index]
          %>

          <div class="overflow-x-auto mt-4">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Indicateur
                  </th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Commune
                  </th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Taux
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <!-- Commune avec le taux le plus bas -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                    Taux le plus bas
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= min_commune["name"] %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= number_to_percentage(min_commune["single_parent_percentage"], precision: 2) %>
                  </td>
                </tr>

                <!-- Commune m√©diane -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                    Valeur m√©diane
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= median_commune["name"] %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= number_to_percentage(median_commune["single_parent_percentage"], precision: 2) %>
                  </td>
                </tr>

                <!-- Commune avec le taux le plus √©lev√© -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                    Taux le plus √©lev√©
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= max_commune["name"] %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= number_to_percentage(max_commune["single_parent_percentage"], precision: 2) %>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Bo√Æte d'information explicative pour les familles monoparentales -->
    <div class="mt-6 bg-gray-50 p-4 rounded-md">
      <h4 class="text-sm font-medium text-gray-700 mb-2">√Ä propos des familles monoparentales</h4>
      <p class="text-sm text-gray-600">
        Cette carte pr√©sente le pourcentage de familles monoparentales parmi l'ensemble des m√©nages de chaque commune.
        Cet indicateur est important pour orienter les politiques sociales, l'acc√®s aux services de garde d'enfants,
        et les aides sp√©cifiques. Les familles monoparentales peuvent avoir des besoins particuliers en termes de
        logement, d'emploi flexible et de soutien communautaire.
      </p>
    </div>

    <!-- Bloc contextuel : Familles monoparentales -->
    <div class="mt-6 bg-gradient-to-r from-purple-50 to-fuchsia-50 border-l-4 border-purple-500 rounded-lg p-6 shadow-sm">
      <div class="flex items-start space-x-4">
        <!-- Ic√¥ne -->
        <div class="flex-shrink-0">
          <div class="p-3 bg-purple-100 rounded-lg">
            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
        </div>

        <!-- Contenu -->
        <div class="flex-1">
          <h4 class="text-lg font-semibold text-gray-900 mb-3">
            üë©‚Äçüëß‚Äçüë¶ Familles monoparentales et enjeux pour la politique de la petite enfance
          </h4>

          <div class="space-y-3 text-sm text-gray-700 leading-relaxed">
            <p class="font-medium text-gray-800">
              <span class="bg-purple-100 px-2 py-1 rounded">Lecture du tableau</span>
            </p>

            <div class="bg-white border border-purple-200 rounded-lg p-4">
              <p class="font-medium text-gray-900 mb-2">üìä Un ph√©nom√®ne croissant avec des vuln√©rabilit√©s marqu√©es</p>
              <p class="text-gray-700 mb-2">
                Pr√®s d'<span class="font-semibold text-purple-700">un enfant sur quatre</span> vit aujourd'hui dans une famille
                monoparentale en France (INSEE, 2023), dont plus de 80 % avec leur m√®re. Ce mode de vie, de plus en plus fr√©quent,
                s'accompagne de <strong>vuln√©rabilit√©s √©conomiques et organisationnelles importantes</strong> : un seul revenu pour le foyer,
                plus forte exposition √† la pauvret√© (pr√®s de <span class="font-semibold text-purple-700">40 %</span> des enfants concern√©s),
                horaires de travail atypiques et charge mentale √©lev√©e.
              </p>
              <p class="text-gray-700">
                Le taux d'activit√© des m√®res seules d'enfants de moins de 3 ans est <strong>inf√©rieur de 20 points</strong> √† celui
                des m√®res en couple, signe que le manque de solutions de garde freine leur insertion professionnelle.
              </p>
            </div>

            <div class="bg-fuchsia-50 border border-fuchsia-300 rounded-lg p-4">
              <p class="font-medium text-gray-900 mb-2">üéØ Des besoins sp√©cifiques en modes de garde</p>
              <p class="text-gray-700">
                Ces familles ont besoin en priorit√© de <strong>modes de garde accessibles, souples et proches du domicile</strong> :
                horaires √©tendus, accueil d'urgence, continuit√© de parcours cr√®che-assistante maternelle-√©cole. Leur situation justifie
                un <strong>acc√®s prioritaire aux places d'accueil</strong>, souvent pr√©vu localement dans les r√®glements d'attribution,
                ainsi que le d√©ploiement de <strong>cr√®ches √† vocation d'insertion professionnelle (AVIP)</strong> pour accompagner
                les m√®res isol√©es vers l'emploi ou la formation.
              </p>
            </div>

            <div class="bg-white border border-purple-200 rounded-lg p-4">
              <p class="font-medium text-gray-900 mb-2">üìã Politiques publiques r√©centes</p>
              <p class="text-gray-700">
                Les politiques publiques r√©centes vont dans ce sens :
              </p>
              <ul class="list-disc list-inside space-y-1 text-gray-700 mt-2 ml-2">
                <li>Majoration du Compl√©ment de mode de garde pour les parents isol√©s</li>
                <li>Extension du dispositif jusqu'√† 12 ans en 2025</li>
                <li>Revalorisation de l'Allocation de soutien familial</li>
                <li>D√©veloppement du Service public de la petite enfance (SPPE) visant une solution d'accueil pour chaque enfant d'ici 2030</li>
              </ul>
            </div>

            <p class="italic text-gray-600 border-l-2 border-purple-300 pl-3 mt-4">
              Pour les collectivit√©s, l'enjeu est double : <strong>reconna√Ætre la monoparentalit√© comme crit√®re explicite de priorit√©</strong>
              dans les modes de garde, et <strong>articuler accompagnement social et acc√®s √† l'emploi</strong>. Soutenir ces familles, c'est
              agir √† la fois pour l'√©galit√© femmes-hommes, la pr√©vention de la pauvret√© des enfants et la vitalit√© √©conomique locale.
            </p>

            <div class="mt-4 pt-3 border-t border-gray-200">
              <p class="text-xs text-gray-500">
                <strong>Sources :</strong> INSEE (2023-2025) ‚Ä¢ CAF/CNAF ‚Ä¢ Minist√®re des Solidarit√©s (2024) ‚Ä¢
                Fanta Beret√© & Xavier Iacovelli, <em>Rapport 2025</em> ‚Ä¢ DREES ‚Äì ER1326 ‚Ä¢
                <em>Familles monoparentales et politique petite enfance</em> (COPAS, 2024)
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Nouveau bloc pour les familles nombreuses -->
    <h3 class="text-md font-medium text-gray-800 mb-4 mt-8">Familles nombreuses</h3>

    <!-- Nouveau tableau de comparaison des familles nombreuses -->
    <div class="mb-6">
      <h4 class="text-sm font-medium text-gray-700 mb-2">Comparaison territoriale (<%= @epci_single_parent_data["year"] %>)</h4>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                √âchelon territorial
              </th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                Taux de familles nombreuses
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <!-- EPCI -->
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                <%= display_territory_name(epci_display_name) %>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <div class="flex items-center">
                  <% epci_rate = @epci_large_families_data["epci_large_families_percentage"] %>
                  <span class="<%= epci_rate && epci_rate > 0 ? "font-semibold" : "" %>">
                    <%= number_to_percentage(epci_rate, precision: 2) %>
                  </span>
                  <% if epci_rate && epci_rate > 0 %>
                    <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                      <div class="bg-purple-600 h-2 rounded-full" style="width: <%= [epci_rate * 100 / 30, 100].min %>%"></div>
                    </div>
                  <% end %>
                </div>
              </td>
            </tr>

            <!-- D√©partement -->
            <% if @department_family_data.present? %>
              <tr>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= department_display_name %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <div class="flex items-center">
                    <%
                      latest_year = @department_family_data&.dig("family_data")&.keys&.sort&.last
                      dept_rate = latest_year ? @department_family_data&.dig("family_data", latest_year, "large_families_percentage") : nil
                    %>
                    <span class="<%= dept_rate && dept_rate > 0 ? "font-semibold" : "" %>">
                      <%= number_to_percentage(dept_rate, precision: 2) %>
                    </span>
                    <% if dept_rate && dept_rate > 0 %>
                      <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                        <div class="bg-blue-600 h-2 rounded-full" style="width: <%= [dept_rate * 100 / 30, 100].min %>%"></div>
                      </div>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>

            <!-- R√©gion -->
            <% if @region_family_data.present? %>
              <tr>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= region_display_name %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <div class="flex items-center">
                    <%
                      latest_year = @region_family_data&.dig("family_data")&.keys&.sort&.last
                      region_rate = latest_year ? @region_family_data&.dig("family_data", latest_year, "large_families_percentage") : nil
                    %>
                    <span class="<%= region_rate && region_rate > 0 ? "font-semibold" : "" %>">
                      <%= number_to_percentage(region_rate, precision: 2) %>
                    </span>
                    <% if region_rate && region_rate > 0 %>
                      <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                        <div class="bg-green-600 h-2 rounded-full" style="width: <%= [region_rate * 100 / 30, 100].min %>%"></div>
                      </div>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>

            <!-- France -->
            <% if @france_family_data.present? %>
              <tr>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                  France
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <div class="flex items-center">
                    <%
                      latest_year = @france_family_data&.dig("family_data")&.keys&.sort&.last
                      france_rate = latest_year ? @france_family_data&.dig("family_data", latest_year, "large_families_percentage") : nil
                    %>
                    <span class="<%= france_rate && france_rate > 0 ? "font-semibold" : "" %>">
                      <%= number_to_percentage(france_rate, precision: 2) %>
                    </span>
                    <% if france_rate && france_rate > 0 %>
                      <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                        <div class="bg-red-600 h-2 rounded-full" style="width: <%= [france_rate * 100 / 30, 100].min %>%"></div>
                      </div>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <div class="mt-2 text-xs text-gray-500">
        <p>Note: Les barres de progression sont calibr√©es pour un maximum de 30%.</p>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Carte des familles nombreuses -->
      <div>
        <h4 class="text-sm font-medium text-gray-700 mb-2">R√©partition des familles nombreuses par commune (<%= @epci_large_families_data["year"] %>)</h4>
        <div id="communes-map-large-families" class="h-[500px] w-full border border-gray-200 rounded-md"></div>
        <div id="large-families-legend" class="mt-3"></div>
      </div>

      <!-- Statistiques de synth√®se des familles nombreuses -->
      <div>
        <h4 class="text-sm font-medium text-gray-700 mb-2">Statistiques des familles nombreuses</h4>

        <div class="bg-gray-50 p-4 rounded-md mb-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Pourcentage moyen EPCI -->
            <div class="bg-white p-3 rounded shadow-sm">
              <h5 class="text-sm font-medium text-gray-700 mb-1">Moyenne EPCI</h5>
              <p class="text-xl font-bold text-blue-600">
                <%= number_to_percentage(@epci_large_families_data["epci_large_families_percentage"], precision: 2) %>
              </p>
            </div>

            <!-- R√©partition 3 enfants/4+ enfants -->
            <div class="bg-white p-3 rounded shadow-sm">
              <h5 class="text-sm font-medium text-gray-700 mb-1">3 enfants</h5>
              <p class="text-xl font-bold text-green-600">
                <%= number_to_percentage(@epci_large_families_data["epci_families_3_children_percentage"], precision: 2) %>
              </p>
            </div>

            <div class="bg-white p-3 rounded shadow-sm">
              <h5 class="text-sm font-medium text-gray-700 mb-1">4 enfants ou +</h5>
              <p class="text-xl font-bold text-yellow-600">
                <%= number_to_percentage(@epci_large_families_data["epci_families_4_plus_percentage"], precision: 2) %>
              </p>
            </div>
          </div>
        </div>

        <% if @epci_large_families_data["communes"].present? %>
          <%
            # Calculer quelques statistiques
            communes = @epci_large_families_data["communes"]
            sorted_communes = communes.sort_by { |c| c["large_families_percentage"] }

            min_commune = sorted_communes.first
            max_commune = sorted_communes.last

            median_index = communes.length / 2
            median_commune = sorted_communes[median_index]
          %>

          <div class="overflow-x-auto mt-4">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Indicateur
                  </th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Commune
                  </th>
                  <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Taux
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <!-- Commune avec le taux le plus bas -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                    Taux le plus bas
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= min_commune["name"] %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= number_to_percentage(min_commune["large_families_percentage"], precision: 2) %>
                  </td>
                </tr>

                <!-- Commune m√©diane -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                    Valeur m√©diane
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= median_commune["name"] %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= number_to_percentage(median_commune["large_families_percentage"], precision: 2) %>
                  </td>
                </tr>

                <!-- Commune avec le taux le plus √©lev√© -->
                <tr>
                  <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                    Taux le plus √©lev√©
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= max_commune["name"] %>
                  </td>
                  <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                    <%= number_to_percentage(max_commune["large_families_percentage"], precision: 2) %>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Bo√Æte d'information explicative pour les familles nombreuses -->
    <div class="mt-6 bg-gray-50 p-4 rounded-md">
      <h4 class="text-sm font-medium text-gray-700 mb-2">√Ä propos des familles nombreuses</h4>
      <p class="text-sm text-gray-600">
        Cette carte repr√©sente le pourcentage de familles nombreuses (3 enfants ou plus) parmi l'ensemble des m√©nages de chaque commune.
        Cet indicateur permet d'identifier les zones o√π les besoins en logements familiaux, en √©quipements scolaires et en services
        adapt√©s aux familles nombreuses sont les plus importants. La pr√©sence de familles nombreuses peut √©galement influencer
        les politiques de transport, d'activit√©s p√©riscolaires et de soutien √† la parentalit√©.
      </p>
    </div>
</div>

<!-- Donn√©es JSON pour la carte -->
<script type="application/json" id="communes-families-geojson">
  <%= raw(@communes_families_geojson) %>
</script>

<!-- Ajouter les donn√©es JSON pour les familles monoparentales -->
<script type="application/json" id="communes-single-parent-geojson">
  <%= raw(@communes_single_parent_geojson) %>
</script>

<script type="application/json" id="communes-large-families-geojson">
  <%= raw(@communes_large_families_geojson) %>
</script>
