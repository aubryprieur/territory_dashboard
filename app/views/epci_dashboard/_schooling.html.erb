<!-- app/views/epci_dashboard/_schooling.html.erb -->
<div class="bg-white shadow rounded-lg p-6 mb-6">
  <h2 class="text-lg font-medium text-gray-900 mb-4">Scolarisation</h2>

  <!-- Statistiques générales sur la scolarisation -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-amber-50 p-4 rounded-lg">
      <h3 class="text-sm font-medium text-amber-800 mb-1">Scolarisation des enfants de 2 ans</h3>
      <p class="text-2xl font-bold text-amber-900">
        <%= number_to_percentage(@epci_schooling_communes_data["average_schooling_rate_2y"] || 0, precision: 1) %>
      </p>
      <p class="text-sm text-amber-600">
        Moyenne sur l'EPCI
      </p>
    </div>
    <div class="bg-green-50 p-4 rounded-lg">
      <h3 class="text-sm font-medium text-green-800 mb-1">Scolarisation des enfants de 3 à 5 ans</h3>
      <p class="text-2xl font-bold text-green-900">
        <%= number_to_percentage(@epci_schooling_communes_data["average_schooling_rate_3_5y"] || 0, precision: 1) %>
      </p>
      <p class="text-sm text-green-600">
        Moyenne sur l'EPCI
      </p>
    </div>
    <div class="bg-indigo-50 p-4 rounded-lg">
      <h3 class="text-sm font-medium text-indigo-800 mb-1">Enfants concernés</h3>
      <p class="text-2xl font-bold text-indigo-900">
        <%
          total_2y = @epci_schooling_communes_data["communes"].sum { |c| c["total_children_2y"].to_f }.round
          total_3_5y = @epci_schooling_communes_data["communes"].sum { |c| c["total_children_3_5y"].to_f }.round
          total = total_2y + total_3_5y
        %>
        <%= number_with_delimiter(total) %>
      </p>
      <p class="text-sm text-indigo-600">
        Enfants de 2 à 5 ans sur le territoire
      </p>
    </div>
  </div>

  <!-- Carte de scolarisation des enfants de 2 ans -->
  <h3 class="text-md font-medium text-gray-800 mb-4">Taux de scolarisation des enfants de 2 ans</h3>

  <!-- Tableau de comparaison des taux de scolarisation à 2 ans -->
  <div class="mb-6">
    <h3 class="text-md font-medium text-gray-800 mb-4">Comparaison des taux de scolarisation des enfants de 2 ans</h3>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Échelon territorial
            </th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Taux de scolarisation à 2 ans
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <!-- Ligne pour l'EPCI -->
          <tr>
            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
              <%= display_territory_name(epci_display_name) %>
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
              <div class="flex items-center">
                <% epci_rate = @epci_schooling_communes_data["average_schooling_rate_2y"] %>
                <span class="<%= epci_rate && epci_rate > 0 ? "font-semibold" : "" %>">
                  <%= number_to_percentage(epci_rate, precision: 1) %>
                </span>
                <% if epci_rate && epci_rate > 0 %>
                  <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                    <div class="bg-amber-600 h-2 rounded-full" style="width: <%= [epci_rate * 100 / 50, 100].min %>%"></div>
                  </div>
                <% end %>
              </div>
            </td>
          </tr>

          <!-- Ligne pour le département -->
          <% if @department_schooling_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <%= department_display_name %>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <div class="flex items-center">
                  <%
                    # Récupérer l'année la plus récente
                    latest_year = @department_schooling_data&.dig("data")&.keys&.sort&.last
                    dept_rate = latest_year ? @department_schooling_data&.dig("data", latest_year, "schooling_rate_2y") : nil
                  %>
                  <span class="<%= dept_rate && dept_rate > 0 ? "font-semibold" : "" %>">
                    <%= number_to_percentage(dept_rate, precision: 1) %>
                  </span>
                  <% if dept_rate && dept_rate > 0 %>
                    <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                      <div class="bg-blue-600 h-2 rounded-full" style="width: <%= [dept_rate * 100 / 50, 100].min %>%"></div>
                    </div>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>

          <!-- Ligne pour la région -->
          <% if @region_schooling_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <%= region_display_name %>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <div class="flex items-center">
                  <%
                    # Récupérer l'année la plus récente
                    latest_year = @region_schooling_data&.dig("data")&.keys&.sort&.last
                    region_rate = latest_year ? @region_schooling_data&.dig("data", latest_year, "schooling_rate_2y") : nil
                  %>
                  <span class="<%= region_rate && region_rate > 0 ? "font-semibold" : "" %>">
                    <%= number_to_percentage(region_rate, precision: 1) %>
                  </span>
                  <% if region_rate && region_rate > 0 %>
                    <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                      <div class="bg-green-600 h-2 rounded-full" style="width: <%= [region_rate * 100 / 50, 100].min %>%"></div>
                    </div>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>

          <!-- Ligne pour la France -->
          <% if @france_schooling_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                France
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <div class="flex items-center">
                  <%
                    # Récupérer l'année la plus récente
                    latest_year = @france_schooling_data&.dig("data")&.keys&.sort&.last
                    france_rate = latest_year ? @france_schooling_data&.dig("data", latest_year, "schooling_rate_2y") : nil
                  %>
                  <span class="<%= france_rate && france_rate > 0 ? "font-semibold" : "" %>">
                    <%= number_to_percentage(france_rate, precision: 1) %>
                  </span>
                  <% if france_rate && france_rate > 0 %>
                    <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                      <div class="bg-red-600 h-2 rounded-full" style="width: <%= [france_rate * 100 / 50, 100].min %>%"></div>
                    </div>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    <div class="mt-2 text-xs text-gray-500">
      <p>Note: Les barres de progression sont calibrées pour un maximum de 50%.</p>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
    <!-- Carte des taux de scolarisation à 2 ans -->
    <div>
      <h4 class="text-sm font-medium text-gray-700 mb-2">Carte par commune (<%= @epci_schooling_communes_data["year"] %>)</h4>
      <div id="communes-map-schooling-2y" class="h-[500px] w-full border border-gray-200 rounded-md"></div>
      <div id="schooling-2y-legend" class="mt-3"></div>
    </div>

    <!-- Tableau des communes avec taux extrêmes -->
    <div>
      <h4 class="text-sm font-medium text-gray-700 mb-2">Communes avec les taux extrêmes</h4>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Commune</th>
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Taux</th>
              <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Enfants scolarisés</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <%
              # Communes avec les taux les plus élevés
              top_communes = @epci_schooling_communes_data["communes"]
                              .select { |c| c["total_children_2y"].to_f >= 5 } # Filtre pour éviter les communes avec trop peu d'enfants
                              .sort_by { |c| -c["schooling_rate_2y"].to_f }
                              .first(3)

              # Communes avec les taux les plus bas
              bottom_communes = @epci_schooling_communes_data["communes"]
                              .select { |c| c["total_children_2y"].to_f >= 5 } # Filtre pour éviter les communes avec trop peu d'enfants
                              .sort_by { |c| c["schooling_rate_2y"].to_f }
                              .first(3)
            %>

            <!-- Entête pour les communes avec les taux les plus élevés -->
            <tr>
              <td colspan="3" class="px-3 py-2 text-sm font-medium text-gray-900 bg-gray-100">Taux les plus élevés</td>
            </tr>

            <% top_communes.each do |commune| %>
              <tr>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900"><%= commune["name"] %></td>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 font-medium text-green-600">
                  <%= number_to_percentage(commune["schooling_rate_2y"], precision: 1) %>
                </td>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">
                  <%= commune["schooled_children_2y"].round(1) %> / <%= commune["total_children_2y"].round(1) %>
                </td>
              </tr>
            <% end %>

            <!-- Entête pour les communes avec les taux les plus bas -->
            <tr>
              <td colspan="3" class="px-3 py-2 text-sm font-medium text-gray-900 bg-gray-100">Taux les plus bas</td>
            </tr>

            <% bottom_communes.each do |commune| %>
              <tr>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900"><%= commune["name"] %></td>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900 font-medium text-red-600">
                  <%= number_to_percentage(commune["schooling_rate_2y"], precision: 1) %>
                </td>
                <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-900">
                  <%= commune["schooled_children_2y"].round(1) %> / <%= commune["total_children_2y"].round(1) %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Bloc contextuel : Scolarisation des enfants de 2 ans -->
  <div class="mt-6 bg-gradient-to-r from-emerald-50 to-green-50 border-l-4 border-emerald-500 rounded-lg p-6 shadow-sm">
    <div class="flex items-start space-x-4">
      <!-- Icône -->
      <div class="flex-shrink-0">
        <div class="p-3 bg-emerald-100 rounded-lg">
          <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
        </div>
      </div>

      <!-- Contenu -->
      <div class="flex-1">
        <h4 class="text-lg font-semibold text-gray-900 mb-3">
          🎓 Lecture du tableau – Scolarisation des enfants de moins de 3 ans
        </h4>

        <div class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <p class="font-medium text-gray-800">
            <span class="bg-emerald-100 px-2 py-1 rounded">Une scolarisation précoce en recul mais stratégique</span>
          </p>

          <p>
            La scolarisation à deux ans reste <strong>marginale à l'échelle nationale</strong> – environ
            <span class="font-semibold text-emerald-700">16 % des enfants de 2 ans aujourd'hui</span>, contre 35 % à la fin des années 1990 –
            mais elle demeure un <strong>levier éducatif et social essentiel</strong> dans certains territoires (DEPP, DREES, 2024).
            Conformément au Code de l'éducation, elle est prioritairement développée dans les zones d'éducation prioritaire et les territoires fragiles,
            urbains comme ruraux.
          </p>

          <div class="bg-white border border-emerald-200 rounded-lg p-4">
            <p class="font-medium text-gray-900 mb-2">🗺️ Des disparités territoriales marquées</p>
            <p class="text-gray-700 mb-2">
              Les données montrent d'importantes disparités : la scolarisation précoce est beaucoup plus fréquente dans
              <strong>l'Ouest et le Nord de la France</strong> que dans les grandes métropoles, notamment en Île-de-France (DEPP, 2022).
            </p>
            <p class="text-gray-700">
              Les travaux récents de la cohorte ELFE (FSU-SNUipp, 2024) soulignent les <strong>bénéfices éducatifs mesurables</strong>
              d'une entrée à l'école dès 2 ans : progrès en motricité fine
              <span class="font-semibold text-emerald-700">(+23 %)</span>, en langage
              <span class="font-semibold text-emerald-700">(+9 %)</span> et en autonomie
              <span class="font-semibold text-emerald-700">(+6 %)</span>, particulièrement marqués chez les enfants de milieux modestes.
            </p>
          </div>

          <div class="bg-green-50 border border-green-300 rounded-lg p-4">
            <p class="font-medium text-gray-900 mb-2">🎯 Un outil d'égalité des chances</p>
            <p class="text-gray-700">
              La scolarisation précoce agit comme un <strong>facteur d'égalité des chances</strong> en compensant une partie des écarts
              de développement liés au contexte familial. Dans un contexte de baisse du nombre d'enfants de moins de 3 ans (INSEE, 2025),
              elle peut constituer un <strong>outil d'équilibre territorial</strong> : elle soutient les familles modestes sans solution de garde,
              prépare l'entrée à la maternelle et participe à la cohérence d'une politique globale de la petite enfance.
            </p>
          </div>

          <p class="italic text-gray-600 border-l-2 border-emerald-300 pl-3 mt-4">
            Pour les politiques locales, l'enjeu n'est pas d'étendre massivement la scolarisation des 2 ans, mais de
            <strong>la cibler là où elle a le plus d'impact</strong>, en complément de l'offre d'accueil existante
            (crèches, assistants maternels).
          </p>

          <div class="mt-4 pt-3 border-t border-gray-200">
            <p class="text-xs text-gray-500">
              <strong>Sources :</strong> DEPP, <em>La scolarisation des enfants de deux ans</em>, 2022 •
              DREES, <em>Les enfants scolarisés à deux ans vont à l'école surtout le matin</em>, Études & Résultats, 2022 •
              FSU-SNUipp, <em>L'école à deux ans, facteur de développement</em>, n°498, juin 2024 •
              INSEE, <em>Bilan démographique 2024</em>, 2025
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Carte de scolarisation des enfants de 3 à 5 ans -->
  <h3 class="text-md font-medium text-gray-800 mb-4 mt-8">Taux de scolarisation des enfants de 3 à 5 ans</h3>

  <!-- Tableau de comparaison des taux de scolarisation de 3 à 5 ans -->
  <div class="mb-6">
    <h4 class="text-sm font-medium text-gray-700 mb-2">Comparaison territoriale des taux de scolarisation des enfants de 3 à 5 ans</h4>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Échelon territorial
            </th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Taux de scolarisation de 3 à 5 ans
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <!-- Ligne pour l'EPCI -->
          <tr>
            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
              <%= display_territory_name(epci_display_name) %>
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
              <div class="flex items-center">
                <% epci_rate = @epci_schooling_communes_data["average_schooling_rate_3_5y"] %>
                <span class="<%= epci_rate && epci_rate > 0 ? "font-semibold" : "" %>">
                  <%= number_to_percentage(epci_rate, precision: 1) %>
                </span>
                <% if epci_rate && epci_rate > 0 %>
                  <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                    <div class="bg-green-600 h-2 rounded-full" style="width: <%= [epci_rate * 100 / 100, 100].min %>%"></div>
                  </div>
                <% end %>
              </div>
            </td>
          </tr>

          <!-- Ligne pour le département -->
          <% if @department_schooling_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <%= department_display_name %>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <div class="flex items-center">
                  <%
                    # Récupérer l'année la plus récente
                    latest_year = @department_schooling_data&.dig("data")&.keys&.sort&.last
                    dept_rate = latest_year ? @department_schooling_data&.dig("data", latest_year, "schooling_rate_3_5y") : nil
                  %>
                  <span class="<%= dept_rate && dept_rate > 0 ? "font-semibold" : "" %>">
                    <%= number_to_percentage(dept_rate, precision: 1) %>
                  </span>
                  <% if dept_rate && dept_rate > 0 %>
                    <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                      <div class="bg-blue-600 h-2 rounded-full" style="width: <%= [dept_rate * 100 / 100, 100].min %>%"></div>
                    </div>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>

          <!-- Ligne pour la région -->
          <% if @region_schooling_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <%= region_display_name %>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <div class="flex items-center">
                  <%
                    # Récupérer l'année la plus récente
                    latest_year = @region_schooling_data&.dig("data")&.keys&.sort&.last
                    region_rate = latest_year ? @region_schooling_data&.dig("data", latest_year, "schooling_rate_3_5y") : nil
                  %>
                  <span class="<%= region_rate && region_rate > 0 ? "font-semibold" : "" %>">
                    <%= number_to_percentage(region_rate, precision: 1) %>
                  </span>
                  <% if region_rate && region_rate > 0 %>
                    <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                      <div class="bg-purple-600 h-2 rounded-full" style="width: <%= [region_rate * 100 / 100, 100].min %>%"></div>
                    </div>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>

          <!-- Ligne pour la France -->
          <% if @france_schooling_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                France
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <div class="flex items-center">
                  <%
                    # Récupérer l'année la plus récente
                    latest_year = @france_schooling_data&.dig("data")&.keys&.sort&.last
                    france_rate = latest_year ? @france_schooling_data&.dig("data", latest_year, "schooling_rate_3_5y") : nil
                  %>
                  <span class="<%= france_rate && france_rate > 0 ? "font-semibold" : "" %>">
                    <%= number_to_percentage(france_rate, precision: 1) %>
                  </span>
                  <% if france_rate && france_rate > 0 %>
                    <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                      <div class="bg-red-600 h-2 rounded-full" style="width: <%= [france_rate * 100 / 100, 100].min %>%"></div>
                    </div>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    <div class="mt-2 text-xs text-gray-500">
      <p>Note: Les taux de scolarisation pour les enfants de 3 à 5 ans étant généralement élevés, les barres de progression sont calibrées sur 100%.</p>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Carte des taux de scolarisation de 3 à 5 ans -->
    <div>
      <h4 class="text-sm font-medium text-gray-700 mb-2">Carte par commune (<%= @epci_schooling_communes_data["year"] %>)</h4>
      <div id="communes-map-schooling-3-5y" class="h-[500px] w-full border border-gray-200 rounded-md"></div>
      <div id="schooling-3-5y-legend" class="mt-3"></div>
    </div>

    <!-- Visualisation des effectifs -->
    <div>
      <h4 class="text-sm font-medium text-gray-700 mb-2">Répartition des effectifs</h4>
      <div class="bg-gray-50 p-4 rounded-md h-full">
        <p class="text-sm text-gray-600 mb-4">
          Les enfants de 3 à 5 ans sont généralement scolarisés à un taux élevé en France. Voici la répartition sur le territoire :
        </p>

        <div class="space-y-4">
          <div>
            <p class="text-sm font-medium text-gray-700 mb-1">Enfants de 3 à 5 ans total</p>
            <p class="text-xl font-bold text-indigo-600">
              <%= number_with_delimiter(total_3_5y) %>
            </p>
          </div>

          <div>
            <p class="text-sm font-medium text-gray-700 mb-1">Enfants de 3 à 5 ans scolarisés</p>
            <%
              total_schooled_3_5y = @epci_schooling_communes_data["communes"].sum { |c| c["schooled_children_3_5y"].to_f }.round
            %>
            <p class="text-xl font-bold text-green-600">
              <%= number_with_delimiter(total_schooled_3_5y) %>
            </p>
          </div>

          <div>
            <p class="text-sm font-medium text-gray-700 mb-1">Taux global de scolarisation 3-5 ans</p>
            <%
              global_rate_3_5y = total_schooled_3_5y.to_f / total_3_5y * 100 if total_3_5y > 0
            %>
            <p class="text-xl font-bold text-blue-600">
              <%= number_to_percentage(global_rate_3_5y || 0, precision: 1) %>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Boîte d'information explicative -->
  <div class="mt-6 bg-gray-50 p-4 rounded-md">
    <h4 class="text-sm font-medium text-gray-700 mb-2">À propos de la scolarisation</h4>
    <p class="text-sm text-gray-600">
      Les enfants de 2 ans peuvent être scolarisés en maternelle sous certaines conditions et selon les places disponibles.
      Les taux de scolarisation à 2 ans varient fortement d'une commune à l'autre et reflètent souvent les priorités éducatives locales.
      En revanche, la scolarisation des enfants de 3 à 5 ans est obligatoire depuis la loi "Pour une École de la confiance" de 2019.
      Ces données permettent d'identifier les zones où des efforts particuliers pourraient être nécessaires pour améliorer l'accès précoce à l'éducation.
    </p>
  </div>
</div>

<!-- Données JSON pour les cartes -->
<script type="application/json" id="communes-schooling-geojson">
  <%= raw(@communes_schooling_geojson) %>
</script>
