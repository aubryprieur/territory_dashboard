<div class="bg-white shadow rounded-lg p-6 mb-6">
  <h2 class="text-lg font-medium text-gray-900 mb-4">Naissances</h2>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Carte des effectifs de naissances -->
    <div>
      <h4 class="text-sm font-medium text-gray-700 mb-2">Carte des naissances par commune (<%= @epci_latest_birth_year %>)</h4>
      <div id="communes-map-births" class="h-[500px] w-full border border-gray-200 rounded-md"></div>
      <div id="births-count-legend" class="mt-3"></div>
    </div>

    <!-- Graphique d'√©volution des naissances -->
    <div>
      <h4 class="text-sm font-medium text-gray-700 mb-2">√âvolution des naissances dans l'EPCI</h4>
      <div class="h-[500px]">
        <canvas id="epci-births-history-chart"></canvas>
      </div>
    </div>
  </div>

  <!-- Bo√Æte d'information explicative -->
  <div class="mt-6 bg-gray-50 p-4 rounded-md">
    <h4 class="text-sm font-medium text-gray-700 mb-2">√Ä propos des naissances</h4>
    <p class="text-sm text-gray-600">
      Cette visualisation pr√©sente √† gauche le nombre de naissances par commune pour l'ann√©e <%= @epci_latest_birth_year %>,
      et √† droite l'√©volution des naissances dans tout l'EPCI sur une p√©riode de <%= @epci_births_data["years_available"].size %> ans.
      Ces donn√©es permettent d'√©valuer le dynamisme d√©mographique et d'anticiper les besoins futurs en services pour la petite enfance.
    </p>
  </div>

  <!-- Bloc contextuel : Perspectives d√©mographiques -->
  <div class="mt-6 bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 rounded-lg p-6 shadow-sm">
    <div class="flex items-start space-x-4">
      <!-- Ic√¥ne -->
      <div class="flex-shrink-0">
        <div class="p-3 bg-blue-100 rounded-lg">
          <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
        </div>
      </div>

      <!-- Contenu -->
      <div class="flex-1">
        <h4 class="text-lg font-semibold text-gray-900 mb-3">
          üìä Contexte d√©mographique : √©volution des naissances et perspectives
        </h4>

        <div class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <p class="font-medium text-gray-800">
            <span class="bg-blue-100 px-2 py-1 rounded">Lecture du tableau</span>
          </p>

          <p>
            La baisse r√©cente du nombre de naissances s'inscrit dans une <strong>tendance nationale durable</strong> de recul de la f√©condit√©.
            Selon l'INED (Population & Soci√©t√©s, n¬∞635, 2025), l'indicateur conjoncturel de f√©condit√© est pass√© de
            <span class="font-semibold text-blue-700">2,0 enfants par femme en 2014</span> √†
            <span class="font-semibold text-blue-700">1,6 en 2024</span>, soit une baisse de 20 % en dix ans.
          </p>

          <p>
            Les projections indiquent que les g√©n√©rations n√©es apr√®s 1985 auront en moyenne entre 1,6 et 1,9 enfant,
            confirmant un mouvement vers des <strong>familles plus petites</strong> et davantage de situations sans enfant.
            Cette √©volution traduit √† la fois un changement des aspirations familiales et un contexte d'incertitude
            sociale et √©cologique qui freine les projets parentaux.
          </p>

          <div class="bg-white border border-blue-200 rounded-lg p-4 mt-4">
            <p class="font-medium text-gray-900 mb-2">üí° Implications pour les politiques publiques :</p>
            <ul class="list-disc list-inside space-y-2 text-gray-700">
              <li>Possible <strong>diminution des besoins globaux d'accueil</strong> √† long terme</li>
              <li>N√©cessit√© d'une <strong>adaptation qualitative</strong> : offre diversifi√©e et de proximit√©</li>
              <li>Maintien de l'√©galit√© d'acc√®s aux modes de garde dans toutes les zones</li>
            </ul>
          </div>

          <p class="italic text-gray-600 border-l-2 border-blue-300 pl-3 mt-4">
            La politique d'accueil du jeune enfant doit articuler deux objectifs : <strong>anticiper une natalit√© plus faible et plus tardive</strong>,
            tout en garantissant l'√©galit√© d'acc√®s aux modes de garde, condition essentielle pour soutenir l'emploi des femmes et la vitalit√© des territoires.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- üÜï BLOC : Projection des naissances 2035 (sc√©nario ICF 1,6) -->
  <% if @women_15_49.present? && @women_15_49 > 0 %>
  <div class="mt-8 bg-gradient-to-r from-rose-50 to-pink-50 border-l-4 border-rose-500 rounded-lg p-6 shadow-sm">
    <div class="flex items-start space-x-4">
      <!-- Ic√¥ne -->
      <div class="flex-shrink-0">
        <div class="p-3 bg-rose-100 rounded-lg">
          <svg class="w-6 h-6 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
      </div>

      <!-- Contenu -->
      <div class="flex-1">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
          üìà Projection des naissances en 2035 (sc√©nario ICF 1,6)
        </h3>

        <!-- 3 cartes KPI -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <!-- Femmes 15-49 ans -->
          <div class="bg-white rounded-lg p-4 border border-rose-200">
            <p class="text-sm text-gray-600 font-medium mb-1">Femmes 15‚Äì49 ans (2024)</p>
            <p class="text-3xl font-bold text-rose-700">
              <%= number_with_delimiter(@women_15_49, delimiter: " ") %>
            </p>
            <p class="text-xs text-gray-500 mt-2">Population fertile de l'EPCI</p>
          </div>

          <!-- Projection naissances -->
          <div class="bg-white rounded-lg p-4 border border-rose-200">
            <p class="text-sm text-gray-600 font-medium mb-1">Naissances estim√©es en 2035</p>
            <p class="text-3xl font-bold text-pink-700">
              <%= number_with_delimiter(@births_projection_2035, delimiter: " ") %>
            </p>
            <p class="text-xs text-gray-500 mt-2">Avec ICF constant √† 1,6</p>
          </div>

          <!-- Ratio femmes/naissances -->
          <div class="bg-white rounded-lg p-4 border border-rose-200">
            <p class="text-sm text-gray-600 font-medium mb-1">Moyenne naissances par femme</p>
            <p class="text-3xl font-bold text-red-700">
              <%= number_with_precision(1.6, precision: 2) %>
            </p>
            <p class="text-xs text-gray-500 mt-2">Indice Conjoncturel de F√©condit√© (ICF)</p>
          </div>
        </div>

        <!-- üÜï Graphique de projection -->
        <div class="mb-6 bg-white rounded-lg p-4 border border-rose-200">
          <h4 class="text-sm font-medium text-gray-700 mb-4">√âvolution et projection des naissances jusqu'en 2035</h4>
          <div class="h-96">
            <canvas id="epci-births-projection-chart"></canvas>
          </div>
        </div>

        <!-- Explication -->
        <div class="bg-white border border-rose-200 rounded-lg p-4 space-y-3">
          <div>
            <p class="font-semibold text-gray-900 text-sm mb-2">üìå M√©thodologie</p>
            <p class="text-sm text-gray-700 leading-relaxed">
              Cette projection s'appuie sur la structure actuelle des femmes en √¢ge de procr√©er (15‚Äì49 ans) de l'EPCI
              et un sc√©nario d'<strong>ICF constant √† 1,6 enfant par femme</strong> jusqu'en 2035.
              Cet indicateur repr√©sente un sc√©nario de <strong>f√©condit√© basse</strong>, contrastant avec le sc√©nario central INSEE
              (ICF √† 1,8) qui anticiperait environ <strong>11 % de naissances suppl√©mentaires</strong>.
            </p>
          </div>

          <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
            <p class="text-xs text-gray-800">
              <strong>‚ö†Ô∏è Hypoth√®ses :</strong>
              Structure par √¢ge de la f√©condit√© stable ‚Ä¢ √Çge moyen √† la maternit√© ~31‚Äì32 ans
              ‚Ä¢ Solde migratoire neutre ‚Ä¢ La f√©condit√© r√©elle pourrait varier selon les tendances locales et r√©gionales.
            </p>
          </div>

          <div class="text-xs text-gray-600 mt-3 pt-3 border-t border-gray-200">
            <p>
              <strong>Source :</strong> Projections INSEE 2021‚Äì2070 ‚Ä¢ Ined Population & Soci√©t√©s ‚Ä¢ Donn√©es actuelles pyramide des √¢ges
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <% end %>

</div>

<!-- Donn√©es JSON pour la carte -->
<script type="application/json" id="communes-births-geojson">
  <%= raw(@communes_births_geojson) %>
</script>

<!-- Donn√©es JSON pour le graphique d'√©volution -->
<script type="application/json" id="epci-births-history-data">
  {
    "years": <%= raw(@epci_births_data["years_available"].to_json) %>,
    "values": <%= raw(@epci_births_data["epci_births_by_year"].values.to_json) %>
  }
</script>

<!-- üÜï Donn√©es JSON pour le graphique de projection -->
<script type="application/json" id="epci-births-projection-data">
  {
    "historical_years": <%= raw(@epci_births_data["years_available"].to_json) %>,
    "historical_values": <%= raw(@epci_births_data["epci_births_by_year"].values.to_json) %>,
    "projection_years": <%= raw(@births_projection_data[:projection_years].to_json) %>,
    "projection_values_low": <%= raw(@births_projection_data[:projection_values_low].to_json) %>,
    "projection_values_central": <%= raw(@births_projection_data[:projection_values_central].to_json) %>,
    "projection_values_high": <%= raw(@births_projection_data[:projection_values_high].to_json) %>,
    "target_low": <%= @births_projection_data[:target_low] %>,
    "target_central": <%= @births_projection_data[:target_central] %>,
    "target_high": <%= @births_projection_data[:target_high] %>
  }
</script>
