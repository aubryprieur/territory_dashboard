<!-- Synth√®se d√©mographique EPCI -->
<div class="bg-white shadow rounded-lg p-6 mb-6">
  <h2 class="text-lg font-medium text-gray-900 mb-4">D√©mographie de l'EPCI</h2>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="bg-indigo-50 p-4 rounded-lg">
      <h3 class="text-sm font-medium text-indigo-800 mb-1">Population totale</h3>
      <p class="text-2xl font-bold text-indigo-900">
        <%= number_with_delimiter(@epci_population_data["total_population"]&.round || 0, delimiter: " ") %>
      </p>
      <p class="text-sm text-indigo-600">
        <%= @epci_population_data["communes_count"] %> communes
      </p>
    </div>
    <div class="bg-blue-50 p-4 rounded-lg">
      <h3 class="text-sm font-medium text-blue-800 mb-1">Hommes</h3>
      <p class="text-2xl font-bold text-blue-900">
        <%= number_with_delimiter(@epci_population_data["men_count"]&.round || 0, delimiter: " ") %>
      </p>
      <p class="text-sm text-blue-600">
        <%= number_to_percentage(@epci_population_data.dig("gender_ratio", "men_percentage") || 0, precision: 1) %> de la population
      </p>
    </div>
    <div class="bg-pink-50 p-4 rounded-lg">
      <h3 class="text-sm font-medium text-pink-800 mb-1">Femmes</h3>
      <p class="text-2xl font-bold text-pink-900">
        <%= number_with_delimiter(@epci_population_data["women_count"]&.round || 0, delimiter: " ") %>
      </p>
      <p class="text-sm text-pink-600">
        <%= number_to_percentage(@epci_population_data.dig("gender_ratio", "women_percentage") || 0, precision: 1) %> de la population
      </p>
    </div>
  </div>

  <!-- Pyramide des √¢ges -->
  <div>
    <h3 class="text-sm font-medium text-gray-700 mb-4">Pyramide des √¢ges</h3>
    <div class="h-120">
      <canvas id="epci-age-pyramid-chart"></canvas>
    </div>
    <script type="application/json" id="epci-age-pyramid-data">
      <%= raw(@epci_age_pyramid_data.to_json) %>
    </script>
  </div>

  <!-- Information explicative -->
  <div class="mt-6 bg-gray-50 p-4 rounded-md">
    <h4 class="text-sm font-medium text-gray-700 mb-2">Lecture de la pyramide des √¢ges</h4>
    <p class="text-sm text-gray-600">
      Cette pyramide des √¢ges pr√©sente la r√©partition de la population par √¢ge et par sexe dans l'ensemble de l'EPCI.
      Les hommes sont repr√©sent√©s √† gauche (en bleu) et les femmes √† droite (en rose).
    </p>
  </div>

  <!-- Bloc contextuel : Pyramide des √¢ges et petite enfance -->
  <div class="mt-6 bg-gradient-to-r from-sky-50 to-blue-50 border-l-4 border-sky-500 rounded-lg p-6 shadow-sm">
    <div class="flex items-start space-x-4">
      <!-- Ic√¥ne -->
      <div class="flex-shrink-0">
        <div class="p-3 bg-sky-100 rounded-lg">
          <svg class="w-6 h-6 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
        </div>
      </div>

      <!-- Contenu -->
      <div class="flex-1">
        <h4 class="text-lg font-semibold text-gray-900 mb-3">
          üìä Lecture du tableau ‚Äì Pyramide des √¢ges et petite enfance
        </h4>

        <div class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <p class="font-medium text-gray-800">
            <span class="bg-sky-100 px-2 py-1 rounded">Un outil d'analyse d√©mographique fondamental</span>
          </p>

          <p>
            La pyramide des √¢ges constitue le <strong>premier niveau d'analyse d√©mographique</strong> d'un territoire.
            Elle offre une photographie √† un instant T de la r√©partition de la population par √¢ge et permet de visualiser
            la forme de la base, <strong>indicatrice du poids des jeunes enfants et des familles en √¢ge d'avoir des enfants</strong>.
            Cet indicateur reste limit√© mais il constitue une bonne introduction aux analyses suivantes (naissances, 0‚Äì3 ans, modes de garde).
          </p>

          <div class="bg-white border border-sky-200 rounded-lg p-4">
            <p class="font-medium text-gray-900 mb-2">üîç Lecture pour la politique de la petite enfance</p>
            <p class="text-gray-700">
              Pour une politique de la petite enfance, la lecture de <strong>la base et des jeunes adultes (20‚Äì40 ans)</strong>
              permet d'estimer le <strong>potentiel de naissances futures</strong> et d'anticiper les besoins en accueil.
            </p>
          </div>

          <div class="bg-blue-50 border border-blue-300 rounded-lg p-4">
            <p class="font-medium text-gray-900 mb-2">üìà Interpr√©tation de la forme de la base</p>
            <div class="space-y-2 text-gray-700">
              <div class="flex items-start space-x-2">
                <span class="text-sky-600 font-bold mt-0.5">‚ñ∏</span>
                <p>
                  <strong>Une base large</strong> traduit un territoire jeune et dynamique,
                  appelant √† <span class="font-semibold text-sky-700">renforcer les capacit√©s d'accueil</span>
                </p>
              </div>
              <div class="flex items-start space-x-2">
                <span class="text-sky-600 font-bold mt-0.5">‚ñ∏</span>
                <p>
                  <strong>Une base √©troite</strong> signale au contraire un vieillissement et la n√©cessit√©
                  d'<span class="font-semibold text-sky-700">adapter les services</span> tout en
                  <span class="font-semibold text-sky-700">attirant de jeunes m√©nages</span>
                </p>
              </div>
            </div>
          </div>

          <p class="italic text-gray-600 border-l-2 border-sky-300 pl-3 mt-4">
            La pyramide des √¢ges permet ainsi d'anticiper l'√©volution d√©mographique et d'ajuster les politiques publiques.
          </p>

          <div class="mt-4 pt-3 border-t border-gray-200">
            <p class="text-xs text-gray-500">
              <strong>Sources :</strong> INSEE (2023) ‚Ä¢ Futuribles, <em>D√©mographie : des EHPAD ou des cr√®ches ?</em>, 2024
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Graphique d'√©volution de la population -->
  <% if @epci_historical_data.present? && @epci_historical_data["epci_population_history"].present? %>
  <div class="mt-8">
    <h3 class="text-sm font-medium text-gray-700 mb-4">√âvolution historique de la population</h3>
    <div class="h-80">
      <canvas id="epci-population-history-chart"></canvas>
    </div>
    <script type="application/json" id="epci-population-history-data">
      <%= raw(@epci_historical_data["epci_population_history"].to_json) %>
    </script>
    <!-- ‚úÖ CORRECTION : Utiliser @epci_name au lieu du helper inexistant -->
    <script type="application/json" id="epci-name-data">
      <%= raw(@epci_name.to_json) %>
    </script>
  </div>

  <!-- Statistiques d'√©volution -->
  <div class="mt-4">
    <% if @epci_historical_data["epci_evolution_percentage"].present? %>
    <p class="text-sm text-gray-600">
      <strong>√âvolution depuis 1968 :</strong> <%= @epci_historical_data["epci_evolution_percentage"]["1968-2021"] %>%
      <span class="<%= @epci_historical_data["epci_evolution_percentage"]["1968-2021"] > 0 ? 'text-green-600' : 'text-red-600' %>">
        (<%= @epci_historical_data["epci_evolution_percentage"]["1968-2021"] > 0 ? '‚Üë' : '‚Üì' %>)
      </span>
    </p>
    <p class="text-sm text-gray-600">
      <strong>√âvolution r√©cente (2015-2021) :</strong> <%= @epci_historical_data["epci_evolution_percentage"]["2015-2021"] %>%
      <span class="<%= @epci_historical_data["epci_evolution_percentage"]["2015-2021"] > 0 ? 'text-green-600' : 'text-red-600' %>">
        (<%= @epci_historical_data["epci_evolution_percentage"]["2015-2021"] > 0 ? '‚Üë' : '‚Üì' %>)
      </span>
    </p>
    <% end %>
  </div>

  <div class="mt-6 bg-gradient-to-r from-slate-50 to-gray-50 border-l-4 border-slate-500 rounded-lg p-6 shadow-sm">
    <div class="flex items-start space-x-4">
      <!-- Ic√¥ne -->
      <div class="flex-shrink-0">
        <div class="p-3 bg-slate-100 rounded-lg">
          <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
        </div>
      </div>

      <!-- Contenu -->
      <div class="flex-1">
        <h4 class="text-lg font-semibold text-gray-900 mb-3">
          üìà Lecture du graphique ‚Äì √âvolution de la population totale et lecture d√©mographique
        </h4>

        <div class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <p>
            L'√©volution de la population traduit les <strong>grandes dynamiques du territoire</strong> : une hausse t√©moigne
            souvent d'une attractivit√© r√©sidentielle ou migratoire, tandis qu'une stagnation ou une baisse peut signaler un
            vieillissement ou un recul des naissances.
          </p>

          <div class="bg-white border border-slate-200 rounded-lg p-4">
            <p class="font-medium text-gray-900 mb-2">‚ö†Ô∏è Attention : Croissance ‚â† Hausse des naissances</p>
            <p class="text-gray-700 mb-2">
              Toutefois, la <strong>croissance d√©mographique n'implique pas n√©cessairement une hausse des naissances</strong> :
              dans de nombreux territoires, l'augmentation r√©cente de la population r√©sulte surtout de
              <span class="font-semibold text-slate-700">l'installation de nouveaux habitants</span> plut√¥t que d'un regain de f√©condit√©.
            </p>
            <p class="text-gray-700">
              √Ä l'inverse, la France conna√Æt depuis plusieurs ann√©es une <strong>baisse g√©n√©ralis√©e des naissances</strong>,
              ce qui peut √† terme r√©duire la part des jeunes enfants, m√™me sur des territoires encore en croissance.
            </p>
          </div>

          <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4">
            <p class="flex items-start space-x-2">
              <span class="text-2xl flex-shrink-0">üëâ</span>
              <span class="text-gray-700">
                Il convient donc de <strong>croiser la lecture de ce graphique avec la courbe des naissances</strong>
                (onglet <span class="font-semibold text-blue-700">¬´ Naissances ¬ª</span>) pour mieux comprendre les
                <strong>dynamiques r√©elles √† l'≈ìuvre</strong> et leurs cons√©quences sur les besoins en accueil du jeune enfant.
              </span>
            </p>
          </div>

          <div class="bg-gray-50 border border-gray-300 rounded-lg p-3 mt-3">
            <p class="text-xs text-gray-600">
              üí° <strong>M√©thode d'analyse :</strong> Comparez syst√©matiquement l'√©volution de la population totale
              avec l'√©volution des naissances pour identifier si la croissance est port√©e par les migrations ou par
              le dynamisme naturel du territoire.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- üéØ BLOC √Ä AJOUTER : Projection 0-3 ans -->
  <% if @epci_population_data.present? && @epci_population_data["population_by_age"].present? %>

    <%
      # Calculer les donn√©es
      population_by_age = @epci_population_data["population_by_age"]

      # Extraire effectifs par √¢ge (0, 1, 2, 3)
      age_data = {}
      (0..3).each do |age|
        age_items = population_by_age.select { |item| item["age"].to_i == age }
        men = age_items.sum { |item| item["men"].to_f }
        women = age_items.sum { |item| item["women"].to_f }
        current = (men + women).round(0)

        age_data[age] = {
          current: current,
          conservative: (current * 0.85).round(0),
          pessimistic: (current * 0.80).round(0)
        }
      end

      # Totaux
      current_total = age_data.map { |_, v| v[:current] }.sum
      conservative_total = age_data.map { |_, v| v[:conservative] }.sum
      pessimistic_total = age_data.map { |_, v| v[:pessimistic] }.sum
    %>

    <!-- Projection simple et √©pur√©e -->
    <div class="mt-8 bg-gradient-to-r from-emerald-50 to-teal-50 border-l-4 border-emerald-500 rounded-lg p-6 shadow-sm">
      <div class="flex items-start space-x-4">
        <!-- Ic√¥ne -->
        <div class="flex-shrink-0">
          <div class="p-3 bg-emerald-100 rounded-lg">
            <svg class="w-6 h-6 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6M3 21h18"></path>
            </svg>
          </div>
        </div>

        <!-- Contenu -->
        <div class="flex-1">
          <h4 class="text-lg font-semibold text-gray-900 mb-6">üìà Projection de la population 0-3 ans √† 10 ans</h4>

          <!-- Population actuelle -->
          <div class="mb-6 bg-white border border-emerald-200 rounded-lg p-6">
            <h5 class="text-sm font-medium text-gray-600 mb-2">Population actuelle</h5>
            <p class="text-4xl font-bold text-emerald-600">
              <%= number_with_delimiter(current_total) %>
            </p>
            <p class="text-sm text-gray-600">enfants de moins de 3 ans dans l'EPCI</p>
          </div>

          <!-- Deux sc√©narios c√¥te √† c√¥te -->
          <div class="grid grid-cols-2 gap-4 mb-6">
            <!-- Sc√©nario Mod√©r√© -15% -->
            <div class="border-2 border-amber-200 rounded-lg p-5 bg-amber-50">
              <div class="flex items-center justify-between mb-3">
                <h6 class="font-semibold text-gray-900">Sc√©nario mod√©r√©</h6>
                <span class="bg-amber-200 text-amber-900 px-2 py-1 rounded text-xs font-bold">-15%</span>
              </div>

              <p class="text-sm text-gray-600 mb-2">Projection (10 ans)</p>
              <p class="text-3xl font-bold text-amber-700 mb-2">
                <%= number_with_delimiter(conservative_total) %>
              </p>

              <p class="text-sm text-gray-600 mb-3">Baisse estim√©e</p>
              <p class="text-xl font-bold text-amber-600 mb-4">
                -<%= number_with_delimiter(current_total - conservative_total) %>
              </p>

              <!-- Barre g√©n√©rale de progression -->
              <div class="w-full bg-amber-200 rounded-full h-3 overflow-hidden mb-4">
                <div class="bg-amber-600 h-full rounded-full" style="width: 85%;"></div>
              </div>

              <!-- D√©tail par tranche d'√¢ge -->
              <div class="border-t border-amber-200 pt-4">
                <% (0..3).each do |age| %>
                  <% age_label = age == 0 ? "0 an" : "#{age} ans" %>
                  <div class="mb-3">
                    <div class="flex justify-between items-center mb-1">
                      <span class="text-xs font-semibold text-gray-700"><%= age_label %></span>
                      <span class="text-xs font-bold text-amber-700">
                        <%= number_with_delimiter(age_data[age][:current]) %> ‚Üí <%= number_with_delimiter(age_data[age][:conservative]) %>
                        <span class="text-amber-600">(-<%= number_with_delimiter(age_data[age][:current] - age_data[age][:conservative]) %>)</span>
                      </span>
                    </div>
                    <div class="w-full bg-amber-100 rounded-full h-2 overflow-hidden">
                      <div class="bg-amber-600 h-full rounded-full" style="width: 85%;"></div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>

            <!-- Sc√©nario Accentu√© -20% -->
            <div class="border-2 border-red-200 rounded-lg p-5 bg-red-50">
              <div class="flex items-center justify-between mb-3">
                <h6 class="font-semibold text-gray-900">Sc√©nario accentu√©</h6>
                <span class="bg-red-200 text-red-900 px-2 py-1 rounded text-xs font-bold">-20%</span>
              </div>

              <p class="text-sm text-gray-600 mb-2">Projection (10 ans)</p>
              <p class="text-3xl font-bold text-red-700 mb-2">
                <%= number_with_delimiter(pessimistic_total) %>
              </p>

              <p class="text-sm text-gray-600 mb-3">Baisse estim√©e</p>
              <p class="text-xl font-bold text-red-600 mb-4">
                -<%= number_with_delimiter(current_total - pessimistic_total) %>
              </p>

              <!-- Barre g√©n√©rale de progression -->
              <div class="w-full bg-red-200 rounded-full h-3 overflow-hidden mb-4">
                <div class="bg-red-600 h-full rounded-full" style="width: 80%;"></div>
              </div>

              <!-- D√©tail par tranche d'√¢ge -->
              <div class="border-t border-red-200 pt-4">
                <% (0..3).each do |age| %>
                  <% age_label = age == 0 ? "0 an" : "#{age} ans" %>
                  <div class="mb-3">
                    <div class="flex justify-between items-center mb-1">
                      <span class="text-xs font-semibold text-gray-700"><%= age_label %></span>
                      <span class="text-xs font-bold text-red-700">
                        <%= number_with_delimiter(age_data[age][:current]) %> ‚Üí <%= number_with_delimiter(age_data[age][:pessimistic]) %>
                        <span class="text-red-600">(-<%= number_with_delimiter(age_data[age][:current] - age_data[age][:pessimistic]) %>)</span>
                      </span>
                    </div>
                    <div class="w-full bg-red-100 rounded-full h-2 overflow-hidden">
                      <div class="bg-red-600 h-full rounded-full" style="width: 80%;"></div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          </div>

          <!-- Implications territoriales -->
          <div class="mb-6 bg-emerald-50 border border-emerald-200 rounded-lg p-6">
            <div class="flex items-start gap-3">
              <span class="text-2xl">üí°</span>
              <div>
                <h5 class="font-semibold text-gray-900 mb-2">Implications territoriales</h5>
                <p class="text-sm text-gray-700 leading-relaxed">
                  Cette projection de baisse devrait guider la <strong>strat√©gie d'accueil de la petite enfance</strong> au niveau intercommunal.
                  Les EPCI doivent <strong>adapter progressivement les capacit√©s d'accueil</strong> (cr√®ches, assistants maternels) tout en veillant
                  √† ne pas cr√©er des ¬´ trous ¬ª de service dans les communes.
                  C'est aussi une opportunit√© pour <strong>renforcer l'attractivit√© familiale</strong> via le logement, les aides et les services.
                </p>
              </div>
            </div>
          </div>

          <!-- Sources -->
          <div class="text-xs text-gray-600">
            <p><strong>Source :</strong> Projections INSEE/INED bas√©es sur la pyramide des √¢ges actuelle et tendances r√©gionales</p>
          </div>
        </div>
      </div>
    </div>

  <% end %>


  <% else %>
  <!-- Message si pas de donn√©es historiques -->
  <div class="mt-8">
    <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium text-yellow-800">Donn√©es historiques non disponibles</h3>
          <p class="text-sm text-yellow-700 mt-1">
            Les donn√©es d'√©volution historique de la population ne sont pas encore disponibles pour cet EPCI.
          </p>
        </div>
      </div>
    </div>
  </div>
  <% end %>
</div>
