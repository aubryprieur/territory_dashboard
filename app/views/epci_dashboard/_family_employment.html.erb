<div class="bg-white shadow rounded-lg p-6 mb-6">
  <h2 class="text-lg font-medium text-gray-900 mb-4">Emploi des familles avec enfants</h2>

  <%
    # R√©cup√©rer l'ann√©e la plus r√©cente disponible
    latest_year = @epci_family_employment_under3_data&.dig("data")&.keys&.sort&.last
    latest_year_3to5 = @epci_family_employment_3to5_data&.dig("data")&.keys&.sort&.last

    # R√©cup√©rer les donn√©es pour chaque √¢ge
    epci_data = @epci_family_employment_under3_data&.dig("data", latest_year) if @epci_family_employment_under3_data.present?
    department_data = @department_family_employment_under3_data&.dig("data", latest_year) if @department_family_employment_under3_data.present?
    region_data = @region_family_employment_under3_data&.dig("data", latest_year) if @region_family_employment_under3_data.present?
    france_data = @france_family_employment_under3_data&.dig("data", latest_year) if @france_family_employment_under3_data.present?

    epci_data_3to5 = @epci_family_employment_3to5_data&.dig("data", latest_year_3to5) if @epci_family_employment_3to5_data.present?
    department_data_3to5 = @department_family_employment_3to5_data&.dig("data", latest_year_3to5) if @department_family_employment_3to5_data.present?
    region_data_3to5 = @region_family_employment_3to5_data&.dig("data", latest_year_3to5) if @region_family_employment_3to5_data.present?
    france_data_3to5 = @france_family_employment_3to5_data&.dig("data", latest_year_3to5) if @france_family_employment_3to5_data.present?

    # D√©finir les cat√©gories simplifi√©es
    category_mapping = {
      "Famille monoparentale - Homme sans emploi" => "P√®re seul sans emploi",
      "Famille monoparentale - Femme active ayant un emploi" => "M√®re seule en emploi",
      "Famille monoparentale - Femme sans emploi" => "M√®re seule sans emploi",
      "Couple avec enfant(s) - Deux parents actifs ayant un emploi" => "Deux parents en emploi",
      "Couple avec enfant(s) - Homme actif ayant un emploi, conjoint sans emploi" => "P√®re en emploi, \nm√®re sans emploi",
      "Couple avec enfant(s) - Femme active ayant un emploi, \nconjoint sans emploi" => "M√®re en emploi, p√®re sans emploi",
      "Couple avec enfant(s) - Aucun parent actif ayant un emploi" => "Aucun parent en emploi",
      "Famille monoparentale - Homme actif ayant un emploi" => "P√®re seul en emploi"
    }

    category_colors = {
      "P√®re seul sans emploi" => "#FCD34D",
      "P√®re seul en emploi" => "#FBBF24",
      "M√®re seule en emploi" => "#60A5FA",
      "M√®re seule sans emploi" => "#F87171",
      "Deux parents en emploi" => "#34D399",
      "P√®re en emploi, m√®re sans emploi" => "#A78BFA",
      "M√®re en emploi, p√®re sans emploi" => "#FCA5A5",
      "Aucun parent en emploi" => "#6B7280"
    }

    # Moins de 3 ans
    chart_categories = []
    epci_percentages = []
    department_percentages = []
    region_percentages = []
    france_percentages = []

    if epci_data&.dig("distributions").present?
      epci_data["distributions"].each do |category, data|
        simple_category = category_mapping[category] || category
        unless chart_categories.include?(simple_category)
          chart_categories << simple_category
          epci_percentages << data["percentage"]
          department_percentages << (department_data&.dig("distributions", category)&.dig("percentage"))
          region_percentages << (region_data&.dig("distributions", category)&.dig("percentage"))
          france_percentages << (france_data&.dig("distributions", category)&.dig("percentage"))
        end
      end
    end

    # 3 √† 5 ans
    chart_categories_3to5 = []
    epci_percentages_3to5 = []
    department_percentages_3to5 = []
    region_percentages_3to5 = []
    france_percentages_3to5 = []

    if epci_data_3to5&.dig("distributions").present?
      epci_data_3to5["distributions"].each do |category, data|
        simple_category = category_mapping[category] || category
        unless chart_categories_3to5.include?(simple_category)
          chart_categories_3to5 << simple_category
          epci_percentages_3to5 << data["percentage"]
          department_percentages_3to5 << (department_data_3to5&.dig("distributions", category)&.dig("percentage"))
          region_percentages_3to5 << (region_data_3to5&.dig("distributions", category)&.dig("percentage"))
          france_percentages_3to5 << (france_data_3to5&.dig("distributions", category)&.dig("percentage"))
        end
      end
    end
  %>

  <% if latest_year.present? && chart_categories.any? %>
    <h3 class="text-sm font-medium text-gray-700 mb-4">Familles avec enfants de moins de 3 ans (<%= latest_year %>)</h3>
    <div class="h-[500px] w-full overflow-x-auto mb-6">
      <canvas id="family-employment-under3-chart-epci"></canvas>
    </div>
    <script type="application/json" id="family-employment-under3-data-epci">
      {
        "categories": <%= raw chart_categories.to_json %>,
        "epci": { "name": "<%= display_territory_name(epci_display_name) %>", "data": <%= raw epci_percentages.to_json %> },
        "department": { "name": "<%= department_display_name %>", "data": <%= raw department_percentages.to_json %> },
        "region": { "name": "<%= region_display_name %>", "data": <%= raw region_percentages.to_json %> },
        "france": { "name": "France", "data": <%= raw france_percentages.to_json %> },
        "colors": <%= raw category_colors.to_json %>
      }
    </script>
  <% end %>

  <% if latest_year_3to5.present? && chart_categories_3to5.any? %>
    <h3 class="text-sm font-medium text-gray-700 mb-4">Familles avec enfants de 3 √† 5 ans (<%= latest_year_3to5 %>)</h3>
    <div class="h-[500px] w-full overflow-x-auto mb-6">
      <canvas id="family-employment-3to5-chart-epci"></canvas>
    </div>
    <script type="application/json" id="family-employment-3to5-data-epci">
      {
        "categories": <%= raw chart_categories_3to5.to_json %>,
        "epci": { "name": "<%= display_territory_name(epci_display_name) %>", "data": <%= raw epci_percentages_3to5.to_json %> },
        "department": { "name": "<%= department_display_name %>", "data": <%= raw department_percentages_3to5.to_json %> },
        "region": { "name": "<%= region_display_name %>", "data": <%= raw region_percentages_3to5.to_json %> },
        "france": { "name": "France", "data": <%= raw france_percentages_3to5.to_json %> },
        "colors": <%= raw category_colors.to_json %>
      }
    </script>
  <% end %>

  <div class="mt-6 bg-gray-50 p-4 rounded-md">
    <h3 class="text-sm font-medium text-gray-700 mb-2">√Ä propos des donn√©es</h3>
    <p class="text-sm text-gray-600 mb-2">
      Ces donn√©es pr√©sentent la r√©partition des situations d'emploi des parents selon l'√¢ge des enfants, √† l'√©chelle de l'EPCI.
    </p>
    <p class="text-sm text-gray-600 italic">
      La tranche 0‚Äì3 ans est souvent associ√©e √† la garde d'enfants √† domicile ou en cr√®che.
      Celle de 3‚Äì5 ans correspond g√©n√©ralement √† la scolarisation en maternelle,
      ce qui peut influencer l'organisation familiale et les choix professionnels.
    </p>
  </div>

  <div class="mt-6 bg-gradient-to-r from-cyan-50 to-blue-50 border-l-4 border-cyan-500 rounded-lg p-6 shadow-sm">
    <div class="flex items-start space-x-4">
      <!-- Ic√¥ne -->
      <div class="flex-shrink-0">
        <div class="p-3 bg-cyan-100 rounded-lg">
          <svg class="w-6 h-6 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
        </div>
      </div>

      <!-- Contenu -->
      <div class="flex-1">
        <h4 class="text-lg font-semibold text-gray-900 mb-3">
          üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Lecture du graphique ‚Äì Contexte sociologique et dynamiques familiales
        </h4>

        <div class="space-y-3 text-sm text-gray-700 leading-relaxed">
          <p class="font-medium text-gray-800">
            <span class="bg-cyan-100 px-2 py-1 rounded">√âvolutions sociologiques r√©centes</span>
          </p>

          <p>
            Les √©volutions sociologiques r√©centes <strong>influencent directement les besoins d'accueil</strong> du jeune enfant.
            La progression des <strong>familles monoparentales</strong> (pr√®s d'un quart des familles avec enfants selon l'INSEE, 2023)
            et la <strong>pr√©carisation de certaines m√®res</strong> de jeunes enfants accentuent la n√©cessit√© de proposer des
            solutions de garde accessibles, souples et inclusives.
          </p>

          <div class="bg-white border border-cyan-200 rounded-lg p-4">
            <p class="font-medium text-gray-900 mb-2">üìä Impact sur l'emploi f√©minin</p>
            <p class="text-gray-700">
              Le <strong>taux d'emploi f√©minin reste √©lev√© en France</strong>, mais
              <span class="font-semibold text-cyan-700">chute fortement lorsque le plus jeune enfant a moins de 3 ans</span>,
              notamment en cas d'horaires atypiques ou de garde insuffisante.
            </p>
          </div>

          <div class="bg-blue-50 border border-blue-300 rounded-lg p-4">
            <p class="font-medium text-gray-900 mb-2">üéØ Adapter l'offre aux r√©alit√©s locales</p>
            <p class="text-gray-700 mb-2">
              Pour les EPCI, ces constats appellent √† <strong>adapter l'offre de garde aux r√©alit√©s professionnelles
              et sociales locales</strong> :
            </p>
            <ul class="list-disc list-inside space-y-1 text-gray-700 ml-2">
              <li><strong>Horaires √©largis</strong> pour r√©pondre aux contraintes professionnelles</li>
              <li><strong>Coordination</strong> entre cr√®ches, assistantes maternelles et √©coles</li>
              <li><strong>Accompagnement</strong> des m√®res isol√©es et des familles √† bas revenus</li>
            </ul>
          </div>

          <div class="bg-white border border-cyan-200 rounded-lg p-4">
            <p class="font-medium text-gray-900 mb-2">üîç Analyser les sp√©cificit√©s territoriales</p>
            <p class="text-gray-700 mb-2">
              Il est essentiel de <strong>comparer les donn√©es du territoire avec les niveaux d√©partemental, r√©gional et national</strong>
              pour identifier les <span class="font-semibold text-cyan-700">sp√©cificit√©s locales</span> et orienter l'action publique.
            </p>
            <p class="text-gray-700 mb-2">
              Par exemple, une <strong>surrepr√©sentation</strong> de certaines situations peut r√©v√©ler des besoins sp√©cifiques :
            </p>
            <ul class="list-disc list-inside space-y-1 text-gray-700 ml-2">
              <li><strong>M√®res seules sans emploi</strong> avec enfants de moins de 3 ans</li>
              <li><strong>Familles sans aucun parent en emploi</strong></li>
              <li><strong>Couples monoactifs</strong> (un seul parent en emploi)</li>
            </ul>
            <p class="text-gray-700 mt-2">
              Ces √©carts par rapport aux moyennes permettent de <span class="font-semibold text-cyan-700">d√©velopper des solutions cibl√©es</span>
              favorisant l'<strong>insertion professionnelle</strong> : cr√®ches √† vocation d'insertion professionnelle (AVIP),
              accompagnement social renforc√©, horaires adapt√©s, aide √† la recherche d'emploi.
            </p>
          </div>

          <div class="bg-white border border-cyan-200 rounded-lg p-4">
            <p class="font-medium text-gray-900 mb-2">üèõÔ∏è Le Service public de la petite enfance (SPPE)</p>
            <p class="text-gray-700">
              Ces actions constituent le <strong>c≈ìur du Service public de la petite enfance</strong>, dont l'enjeu est de :
            </p>
            <ul class="list-disc list-inside space-y-1 text-gray-700 mt-2 ml-2">
              <li>Garantir √† <strong>chaque famille une solution adapt√©e</strong></li>
              <li>Soutenir l'<strong>√©galit√© professionnelle</strong> entre hommes et femmes</li>
              <li>Lutter contre la <strong>pauvret√© des enfants</strong></li>
            </ul>
          </div>

          <p class="italic text-gray-600 border-l-2 border-cyan-300 pl-3 mt-4">
            L'accueil du jeune enfant est ainsi un <strong>levier majeur de coh√©sion sociale</strong> et d'√©galit√©,
            permettant aux familles de concilier vie professionnelle et vie familiale dans des conditions dignes.
          </p>

          <div class="mt-4 pt-3 border-t border-gray-200">
            <p class="text-xs text-gray-500">
              <strong>Sources :</strong> INSEE, <em>Les familles en 2020</em> (Insee Focus n¬∞249) ‚Ä¢
              DREES, <em>Les m√®res seules</em> (√âtudes & R√©sultats n¬∞960, 2020) ‚Ä¢
              HCFEA, <em>√âtat des lieux de l'accueil des jeunes enfants</em>, 2023 ‚Ä¢
              UNCCAS, <em>Accueil en cr√®che et horaires de travail</em>, 2023
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>
