<!-- Modes d'accueil petite enfance -->
<div class="bg-white shadow rounded-lg p-6 mb-6">
  <h2 class="text-lg font-medium text-gray-900 mb-4">Accueil de la petite enfance</h2>

  <%
    # D√©terminer d'abord l'ann√©e la plus r√©cente disponible pour la commune
    commune_years = @childcare_data&.dig("coverage_data")&.keys || []
    reference_year = commune_years.sort.last

    # R√©cup√©rer les donn√©es pour la commune pour cette ann√©e de r√©f√©rence
    latest_childcare = @childcare_data&.dig("coverage_data", reference_year)&.dig("coverage_rates") if reference_year

    # R√©cup√©rer les donn√©es des autres territoires pour la m√™me ann√©e de r√©f√©rence
    epci_childcare = @epci_childcare_data&.dig("coverage_data", reference_year)&.dig("coverage_rates") if reference_year
    department_childcare = @department_childcare_data&.dig("coverage_data", reference_year)&.dig("coverage_rates") if reference_year
    region_childcare = @region_childcare_data&.dig("coverage_data", reference_year)&.dig("coverage_rates") if reference_year
    france_childcare = @france_childcare_data&.dig("coverage_data", reference_year)&.dig("coverage_rates") if reference_year

    # Fonction helper pour afficher "N.C." si la valeur est exactement 0.0
    def format_rate(rate)
      if rate.nil? || rate == 0.0
        "N.C."
      else
        number_to_percentage(rate, precision: 1)
      end
    end
  %>

  <h3 class="text-sm font-medium text-gray-700 mb-2">Modes d'accueil petite enfance (<%= reference_year || 'N/A' %>)</h3>
  <% if latest_childcare %>
    <div class="space-y-2">
      <div class="flex justify-between items-center">
        <span class="text-sm text-gray-600">Accueil collectif</span>
        <span class="font-medium"><%= format_rate(latest_childcare["eaje_total"]) %></span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2.5">
        <div class="bg-blue-600 h-2.5 rounded-full" style="width: <%= latest_childcare["eaje_total"] || 0 %>%"></div>
      </div>

      <div class="flex justify-between items-center">
        <span class="text-sm text-gray-600">Assistantes maternelles</span>
        <span class="font-medium"><%= format_rate(latest_childcare["childminder"]) %></span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2.5">
        <div class="bg-green-600 h-2.5 rounded-full" style="width: <%= latest_childcare["childminder"] || 0 %>%"></div>
      </div>

      <div class="flex justify-between items-center">
        <span class="text-sm text-gray-600">Pr√©scolarisation</span>
        <span class="font-medium"><%= format_rate(latest_childcare["preschool"]) %></span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2.5">
        <div class="bg-purple-600 h-2.5 rounded-full" style="width: <%= latest_childcare["preschool"] || 0 %>%"></div>
      </div>

      <div class="flex justify-between items-center mt-4">
        <span class="text-sm font-medium text-gray-700">Couverture globale</span>
        <span class="font-bold"><%= format_rate(latest_childcare["global"]) %></span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-3">
        <div class="bg-indigo-600 h-3 rounded-full" style="width: <%= latest_childcare["global"] || 0 %>%"></div>
      </div>
    </div>
  <% else %>
    <p class="text-gray-500 italic">Donn√©es non disponibles</p>
  <% end %>

  <!-- Tableau comparatif entre territoires -->
  <% if reference_year.present? %>
    <div class="mt-8">
      <h3 class="text-sm font-medium text-gray-700 mb-4">Comparaison territoriale des taux d'accueil (<%= reference_year %>)</h3>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Territoire</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Accueil collectif</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assistantes maternelles</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pr√©scolarisation</th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Couverture globale</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <!-- Ligne pour la commune -->
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900"><%= @territory_name %></td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <%= format_rate(latest_childcare&.dig("eaje_total")) %>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <%= format_rate(latest_childcare&.dig("childminder")) %>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <%= format_rate(latest_childcare&.dig("preschool")) %>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">
                <%= format_rate(latest_childcare&.dig("global")) %>
              </td>
            </tr>

            <!-- Ligne pour l'EPCI si disponible -->
            <% if epci_childcare %>
              <tr>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 max-w-xs" title="<%= epci_display_name %>">
                  <div class="truncate">
                    <%= display_territory_name(epci_display_name) %>
                  </div>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= format_rate(epci_childcare["eaje_total"]) %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= format_rate(epci_childcare["childminder"]) %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= format_rate(epci_childcare["preschool"]) %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">
                  <%= format_rate(epci_childcare["global"]) %>
                </td>
              </tr>
            <% end %>

            <!-- Ligne pour le d√©partement si disponible -->
            <% if department_childcare %>
              <tr>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 max-w-xs" title="<%= department_display_name %>">
                  <div class="truncate">
                    <%= display_territory_name(department_display_name) %>
                  </div>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= format_rate(department_childcare["eaje_total"]) %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= format_rate(department_childcare["childminder"]) %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= format_rate(department_childcare["preschool"]) %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">
                  <%= format_rate(department_childcare["global"]) %>
                </td>
              </tr>
            <% end %>

            <!-- Ligne pour la r√©gion si disponible -->
            <% if region_childcare %>
              <tr>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 max-w-xs" title="<%= region_display_name %>">
                  <div class="truncate">
                    <%= display_territory_name(region_display_name) %>
                  </div>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= format_rate(region_childcare["eaje_total"]) %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= format_rate(region_childcare["childminder"]) %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= format_rate(region_childcare["preschool"]) %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">
                  <%= format_rate(region_childcare["global"]) %>
                </td>
              </tr>
            <% end %>

            <!-- Ligne pour la France si disponible -->
            <% if france_childcare %>
              <tr>
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                  France
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= format_rate(france_childcare["eaje_total"]) %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= format_rate(france_childcare["childminder"]) %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                  <%= format_rate(france_childcare["preschool"]) %>
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 font-medium">
                  <%= format_rate(france_childcare["global"]) %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>

  <!-- üÜï PROJECTION TAUX DE COUVERTURE 2035 -->
  <% if childcare_coverage_projection.present? %>
  <div class="mt-8 bg-gradient-to-r from-cyan-50 to-blue-50 border-l-4 border-cyan-500 rounded-lg p-6 shadow-sm mb-6">
    <div class="flex items-start space-x-4">
      <!-- Ic√¥ne -->
      <div class="flex-shrink-0">
        <div class="p-3 bg-cyan-100 rounded-lg">
          <svg class="w-6 h-6 text-cyan-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
        </div>
      </div>

      <!-- Contenu -->
      <div class="flex-1">
        <h4 class="text-lg font-semibold text-gray-900 mb-4">
          üîÆ Projection du taux de couverture en 2035
        </h4>

        <!-- KPI actuels -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <div class="bg-white rounded-lg p-4 border border-cyan-200">
            <p class="text-sm text-gray-600 font-medium mb-1">Enfants 0-3 ans (ann√©e actuelle)</p>
            <p class="text-3xl font-bold text-cyan-700">
              <%= number_with_delimiter(childcare_coverage_projection[:current_children], delimiter: " ") %>
            </p>
          </div>

          <div class="bg-white rounded-lg p-4 border border-cyan-200">
            <p class="text-sm text-gray-600 font-medium mb-1">Enfants 0-3 ans (projection 2035)</p>
            <p class="text-3xl font-bold text-cyan-700">
              <%= number_with_delimiter(childcare_coverage_projection[:projected_children], delimiter: " ") %>
            </p>
            <p class="text-xs text-gray-500 mt-1">
              <span class="<%= childcare_coverage_projection[:children_evolution_pct] >= 0 ? 'text-green-600' : 'text-red-600' %>">
                <%= childcare_coverage_projection[:children_evolution_pct] >= 0 ? '+' : '' %><%= childcare_coverage_projection[:children_evolution_pct] %>%
              </span>
            </p>
          </div>

          <div class="bg-white rounded-lg p-4 border border-cyan-200">
            <p class="text-sm text-gray-600 font-medium mb-1">Places d'accueil actuelles</p>
            <p class="text-3xl font-bold text-cyan-700">
              <%= number_with_delimiter(childcare_coverage_projection[:current_places], delimiter: " ") %>
            </p>
            <p class="text-xs text-gray-500 mt-1">
              (Taux <%= number_to_percentage(childcare_coverage_projection[:current_rate], precision: 1) %>)
            </p>
          </div>
        </div>

        <!-- 3 Sc√©narios -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <% childcare_coverage_projection[:scenarios].each do |scenario_key, scenario| %>
            <div class="bg-white border-2 <%= scenario_key == :proportional ? 'border-cyan-500 shadow-md' : 'border-gray-200' %> rounded-lg p-4">
              <p class="font-semibold text-gray-900 mb-3">
                <%= scenario[:label] %>
                <% if scenario_key == :proportional %>
                  <span class="ml-2 inline-block px-2 py-1 bg-cyan-100 text-cyan-800 text-xs rounded font-medium">R√©f√©rence</span>
                <% end %>
              </p>

              <div class="space-y-2 mb-4">
                <div>
                  <p class="text-sm text-gray-600">Taux de couverture projet√©</p>
                  <p class="text-2xl font-bold <%= scenario[:evolution] >= 0 ? 'text-green-600' : 'text-red-600' %>">
                    <%= number_to_percentage(scenario[:rate], precision: 1) %>
                  </p>
                </div>

                <div class="flex justify-between items-center pt-2 border-t border-gray-200">
                  <span class="text-xs text-gray-500">√âvolution</span>
                  <span class="text-sm font-semibold <%= scenario[:evolution] >= 0 ? 'text-green-600' : 'text-red-600' %>">
                    <%= scenario[:evolution] >= 0 ? '+' : '' %><%= scenario[:evolution] %>%
                  </span>
                </div>

                <div class="flex justify-between items-center">
                  <span class="text-xs text-gray-500">Places n√©cessaires</span>
                  <span class="text-sm font-medium text-gray-900">
                    <%= number_with_delimiter(scenario[:places], delimiter: " ") %>
                  </span>
                </div>
              </div>

              <p class="text-xs text-gray-600 italic">
                <%= scenario[:description] %>
              </p>
            </div>
          <% end %>
        </div>

        <!-- Bloc m√©thodologique -->
        <div class="bg-white border border-cyan-200 rounded-lg p-4">
          <p class="font-semibold text-gray-900 text-sm mb-3">üìå M√©thodologie</p>
          <div class="space-y-2 text-sm text-gray-700">
            <p>
              <strong>Formule :</strong> Taux 2035 = (Places 2035 / Enfants projet√©s 2035) √ó 100
            </p>
            <p>
              <strong>Places actuelles :</strong> <%= number_with_delimiter(childcare_coverage_projection[:current_places], delimiter: " ") %>
              = <%= number_to_percentage(childcare_coverage_projection[:current_rate], precision: 1) %> √ó
              <%= number_with_delimiter(childcare_coverage_projection[:current_children], delimiter: " ") %> enfants
            </p>
            <p class="bg-cyan-50 p-2 rounded border border-cyan-200">
              Les trois sc√©narios testent diff√©rentes hypoth√®ses d'offre : une offre stable, une offre qui suit la d√©mographie,
              ou une offre volontariste (+20%). Le sc√©nario de r√©f√©rence (proportionnel) suppose un maintien de la couverture
              malgr√© l'√©volution du nombre d'enfants.
            </p>
          </div>
        </div>

        <!-- Alerte contextuelle -->
        <div class="mt-4 bg-amber-50 border border-amber-300 rounded-lg p-4">
          <p class="font-medium text-amber-900 text-sm mb-2">‚ö†Ô∏è Contexte crucial</p>
          <p class="text-sm text-amber-800">
            Cette projection d√©pend fortement de la dynamique future de l'offre d'accueil.
            Elle suppose une r√©partition stable des places par mode d'accueil.
            Le vieillissement des assistantes maternelles pourrait r√©duire l'offre individuelle ind√©pendamment de ces sc√©narios.
          </p>
        </div>
      </div>
    </div>
  </div>
  <% end %>
</div>
