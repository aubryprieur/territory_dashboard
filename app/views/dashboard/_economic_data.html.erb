<!-- Donn√©es √©conomiques -->
<div class="bg-white shadow rounded-lg p-6 mb-6">
  <h2 class="text-lg font-medium text-gray-900 mb-4">Indicateurs socio-√©conomiques</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <!-- Revenus m√©dians historiques - transform√© en graphique -->
    <div>
      <h3 class="text-sm font-medium text-gray-700 mb-2">√âvolution des revenus m√©dians (‚Ç¨)</h3>
      <div class="h-64">
        <canvas id="revenue-chart"></canvas>
      </div>
    </div>
    <!-- Tableau comparatif des revenus m√©dians avec √©volution des √©carts am√©lior√©e -->
    <div>
      <h3 class="text-sm font-medium text-gray-700 mb-2">Comparaison des revenus m√©dians (‚Ç¨)</h3>
      <%
        # Trouver l'ann√©e la plus r√©cente commune √† tous les territoires
        commune_years = @revenue_data&.dig("median_revenues")&.keys || []
        epci_years = @epci_revenue_data&.dig("median_revenues")&.keys || []
        department_years = @department_revenue_data&.dig("median_revenues")&.keys || []
        region_years = @region_revenue_data&.dig("median_revenues")&.keys || []
        france_years = @france_revenue_data&.dig("median_revenues")&.keys || []

        all_years = (commune_years + epci_years + department_years + region_years + france_years).uniq
        latest_year = all_years.sort.last
        oldest_year = all_years.sort.first

        # R√©cup√©rer les valeurs pour la commune
        commune_latest = @revenue_data&.dig("median_revenues", latest_year)
        commune_oldest = @revenue_data&.dig("median_revenues", oldest_year)
      %>

      <table class="min-w-full divide-y divide-gray-200">
        <thead>
          <tr>
            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Territoire</th>
            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Revenu m√©dian (<%= latest_year || 'N/A' %>)
            </th>
            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              √âvolution comparative (<%= oldest_year || 'N/A' %> - <%= latest_year || 'N/A' %>)
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <!-- Ligne pour la commune -->
          <tr>
            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">
              <%= @territory_name %>
            </td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
              <%= number_to_currency(commune_latest || 'N/A', unit: "‚Ç¨", separator: ",", delimiter: " ", format: "%n %u") %>
            </td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">
              R√©f√©rence
            </td>
          </tr>

          <!-- Ligne pour l'EPCI si disponible -->
          <% if @epci_revenue_data.present? %>
            <%
              epci_latest = @epci_revenue_data&.dig("median_revenues", latest_year)
              epci_oldest = @epci_revenue_data&.dig("median_revenues", oldest_year)
              epci_name = @epci_revenue_data&.dig("name") || "EPCI"

              # Utilisation du nouveau service d'analyse
              analysis_result = analyze_revenue_gap(
                @territory_name,
                commune_oldest,
                commune_latest,
                epci_oldest,
                epci_latest,
                epci_name
              )
            %>
            <tr>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <%= epci_name %>
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <%= number_to_currency(epci_latest || 'N/A', unit: "‚Ç¨", separator: ",", delimiter: " ", format: "%n %u") %>
              </td>
              <%= format_revenue_analysis_cell(analysis_result) %>
            </tr>
          <% end %>

          <!-- Ligne pour le d√©partement si disponible -->
          <% if @department_revenue_data.present? %>
            <%
              dept_latest = @department_revenue_data&.dig("median_revenues", latest_year)
              dept_oldest = @department_revenue_data&.dig("median_revenues", oldest_year)
              dept_name = @department_revenue_data&.dig("name") || "D√©partement"

              # Utilisation du nouveau service d'analyse
              analysis_result = analyze_revenue_gap(
                @territory_name,
                commune_oldest,
                commune_latest,
                dept_oldest,
                dept_latest,
                dept_name
              )
            %>
            <tr>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <%= dept_name %>
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <%= number_to_currency(dept_latest || 'N/A', unit: "‚Ç¨", separator: ",", delimiter: " ", format: "%n %u") %>
              </td>
              <%= format_revenue_analysis_cell(analysis_result) %>
            </tr>
          <% end %>

          <!-- Ligne pour la r√©gion si disponible -->
          <% if @region_revenue_data.present? %>
            <%
              region_latest = @region_revenue_data&.dig("median_revenues", latest_year)
              region_oldest = @region_revenue_data&.dig("median_revenues", oldest_year)
              region_name = @region_revenue_data&.dig("name") || "R√©gion"

              # Utilisation du nouveau service d'analyse
              analysis_result = analyze_revenue_gap(
                @territory_name,
                commune_oldest,
                commune_latest,
                region_oldest,
                region_latest,
                region_name
              )
            %>
            <tr>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <%= region_name %>
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <%= number_to_currency(region_latest || 'N/A', unit: "‚Ç¨", separator: ",", delimiter: " ", format: "%n %u") %>
              </td>
              <%= format_revenue_analysis_cell(analysis_result) %>
            </tr>
          <% end %>

          <!-- Ligne pour la France -->
          <% if @france_revenue_data.present? %>
            <%
              france_latest = @france_revenue_data&.dig("median_revenues", latest_year)
              france_oldest = @france_revenue_data&.dig("median_revenues", oldest_year)

              # Utilisation du nouveau service d'analyse
              analysis_result = analyze_revenue_gap(
                @territory_name,
                commune_oldest,
                commune_latest,
                france_oldest,
                france_latest,
                "France"
              )
            %>
            <tr>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                France
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <%= number_to_currency(france_latest || 'N/A', unit: "‚Ç¨", separator: ",", delimiter: " ", format: "%n %u") %>
              </td>
              <%= format_revenue_analysis_cell(analysis_result) %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Section explicative am√©lior√©e -->
  <div class="mt-4 mb-8 bg-blue-50 p-4 rounded-md">
    <h4 class="text-sm font-medium text-blue-900 mb-2">
      <svg class="inline w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      Interpr√©tation de l'√©volution comparative
    </h4>
    <div class="text-sm text-blue-800 space-y-1">
      <p><span class="font-medium text-green-600">‚Ä¢ Rattrapage en cours / Avantage renforc√© :</span> √âvolution favorable pour la commune</p>
      <p><span class="font-medium text-orange-500">‚Ä¢ Avantage r√©duit :</span> La commune maintient son avance mais celle-ci diminue</p>
      <p><span class="font-medium text-red-600">‚Ä¢ Retard accentu√© / Retournement d√©favorable :</span> √âvolution d√©favorable pour la commune</p>
      <p class="mt-2 text-xs">üí° Survolez les indicateurs pour voir les d√©tails (taux de croissance, interpr√©tation)</p>
    </div>
  </div>

  <!-- Deuxi√®me rang√©e pour les taux de pauvret√© -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Taux de pauvret√© historiques - transform√© en graphique -->
    <div>
      <h3 class="text-sm font-medium text-gray-700 mb-2">√âvolution du taux de pauvret√© (%)</h3>
      <div class="h-64">
        <canvas id="poverty-chart"></canvas>
      </div>
    </div>

    <!-- Nouveau tableau comparatif des taux de pauvret√© -->
    <div>
      <h3 class="text-sm font-medium text-gray-700 mb-2">Comparaison des taux de pauvret√© (%)</h3>
      <%
        # Trouver l'ann√©e la plus r√©cente commune √† tous les territoires pour les taux de pauvret√©
        commune_poverty_years = @revenue_data&.dig("poverty_rates")&.keys || []
        epci_poverty_years = @epci_revenue_data&.dig("poverty_rates")&.keys || []
        department_poverty_years = @department_revenue_data&.dig("poverty_rates")&.keys || []
        region_poverty_years = @region_revenue_data&.dig("poverty_rates")&.keys || []
        france_poverty_years = @france_revenue_data&.dig("poverty_rates")&.keys || []

        all_poverty_years = (commune_poverty_years + epci_poverty_years + department_poverty_years + region_poverty_years + france_poverty_years).uniq
        latest_poverty_year = all_poverty_years.sort.last
      %>

      <table class="min-w-full divide-y divide-gray-200">
        <thead>
          <tr>
            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Territoire</th>
            <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Taux de pauvret√© (<%= latest_poverty_year || 'N/A' %>)
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <!-- Ligne pour la commune -->
          <tr>
            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">
              <%= @territory_name %>
            </td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
              <%= number_to_percentage(@revenue_data&.dig("poverty_rates", latest_poverty_year) || 'N/A', precision: 1) %>
            </td>
          </tr>

          <!-- Ligne pour l'EPCI si disponible -->
          <% if @epci_revenue_data.present? %>
            <tr>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <%= @epci_revenue_data&.dig("name") || "EPCI" %>
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <%= number_to_percentage(@epci_revenue_data&.dig("poverty_rates", latest_poverty_year) || 'N/A', precision: 1) %>
              </td>
            </tr>
          <% end %>

          <!-- Ligne pour le d√©partement si disponible -->
          <% if @department_revenue_data.present? %>
            <tr>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <%= @department_revenue_data&.dig("name") || "D√©partement" %>
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <%= number_to_percentage(@department_revenue_data&.dig("poverty_rates", latest_poverty_year) || 'N/A', precision: 1) %>
              </td>
            </tr>
          <% end %>

          <!-- Ligne pour la r√©gion si disponible -->
          <% if @region_revenue_data.present? %>
            <tr>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <%= @region_revenue_data&.dig("name") || "R√©gion" %>
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <%= number_to_percentage(@region_revenue_data&.dig("poverty_rates", latest_poverty_year) || 'N/A', precision: 1) %>
              </td>
            </tr>
          <% end %>

          <!-- Ligne pour la France -->
          <tr>
            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">
              France
            </td>
            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
              <%= number_to_percentage(@france_revenue_data&.dig("poverty_rates", latest_poverty_year) || 'N/A', precision: 1) %>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
