<!-- Comparaison des donn√©es enfants -->
<div class="bg-white shadow rounded-lg p-6 mb-6">
  <h2 class="text-lg font-medium text-gray-900 mb-6">Les enfants</h2>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- SECTION 1 : ENFANTS DE MOINS DE 3 ANS -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <div class="mb-8">
    <h3 class="text-sm font-medium text-gray-700 mb-4">
      üìç Enfants de moins de 3 ans
    </h3>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Territoire
            </th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Part dans la population (%)
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <!-- Commune -->
          <tr>
            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
              <%= @territory_name %>
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
              <% commune_rate = @children_data&.dig("under_3_rate") || 0 %>
              <%= number_to_percentage(commune_rate, precision: 2) %>
            </td>
          </tr>

          <!-- EPCI -->
          <% if @epci_children_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 max-w-xs" title="<%= epci_display_name %>">
                <div class="truncate">
                  <%= display_territory_name(epci_display_name) %>
                </div>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <% epci_rate = @epci_children_data["under_3_rate"] rescue 0 %>
                <%= number_to_percentage(epci_rate, precision: 2) %>
              </td>
            </tr>
          <% end %>

          <!-- D√©partement -->
          <% if @department_children_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 max-w-xs" title="<%= department_display_name %>">
                <div class="truncate">
                  <%= display_territory_name(department_display_name) %>
                </div>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <% dept_rate = @department_children_data["under_3_rate"] rescue 0 %>
                <%= number_to_percentage(dept_rate, precision: 2) %>
              </td>
            </tr>
          <% end %>

          <!-- R√©gion -->
          <% if @region_children_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 max-w-xs" title="<%= region_display_name %>">
                <div class="truncate">
                  <%= display_territory_name(region_display_name) %>
                </div>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <% region_rate = @region_children_data["under_3_rate"] rescue 0 %>
                <%= number_to_percentage(region_rate, precision: 2) %>
              </td>
            </tr>
          <% end %>

          <!-- France -->
          <% if @france_children_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                France
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <% france_rate = @france_children_data["under_3_rate"] rescue 0 %>
                <%= number_to_percentage(france_rate, precision: 2) %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- SECTION 2 : BLOC DE PROJECTION (√Ä AJOUTER APR√àS REFACTORISATION) -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- üÜï BLOC : Projection du nombre d'enfants de moins de 3 ans en 2035 -->
  <% if local_assigns[:children_0_3_projection_2035].present? && local_assigns[:children_0_3_projection_2035][:stable].present? %>
  <div class="bg-gradient-to-r from-violet-50 to-purple-50 border-l-4 border-violet-500 rounded-lg p-6 shadow-sm mb-6">
    <div class="flex items-start space-x-4">
      <!-- Ic√¥ne -->
      <div class="flex-shrink-0">
        <div class="p-3 bg-violet-100 rounded-lg">
          <svg class="w-6 h-6 text-violet-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
        </div>
      </div>

      <!-- Contenu -->
      <div class="flex-1">
        <h4 class="text-lg font-semibold text-gray-900 mb-4">
          üìä Projection du nombre d'enfants de moins de 3 ans en 2035
        </h4>

        <!-- KPI actuels vs projet√©s -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div class="bg-white rounded-lg p-4 border border-violet-200">
            <p class="text-sm text-gray-600 font-medium mb-1">Enfants 0-3 ans actuellement (2024)</p>
            <p class="text-3xl font-bold text-indigo-700">
              <%= number_with_delimiter(local_assigns[:current_children_0_3] || 0, delimiter: " ") %>
            </p>
          </div>

          <div class="bg-white rounded-lg p-4 border border-violet-200">
            <p class="text-sm text-gray-600 font-medium mb-1">Enfants 0-3 ans projet√©s (2035)</p>
            <p class="text-3xl font-bold text-violet-700">
              Entre <%= number_with_delimiter(local_assigns[:children_0_3_projection_2035][:minus_10], delimiter: " ") %> et
              <%= number_with_delimiter(local_assigns[:children_0_3_projection_2035][:stable], delimiter: " ") %>
            </p>
            <p class="text-xs text-gray-500 mt-1">
              <% evolution_stable = local_assigns[:children_0_3_projection_2035][:stable] - (local_assigns[:current_children_0_3] || 0) %>
              <% evolution_minus_10 = local_assigns[:children_0_3_projection_2035][:minus_10] - (local_assigns[:current_children_0_3] || 0) %>
              <span class="<%= evolution_stable >= 0 ? 'text-green-600' : 'text-red-600' %>">
                <%= evolution_stable >= 0 ? '+' : '' %><%= number_with_delimiter(evolution_stable) %> (stable) √†
                <%= evolution_minus_10 >= 0 ? '+' : '' %><%= number_with_delimiter(evolution_minus_10) %> (-10%)
              </span>
            </p>
          </div>
        </div>

        <!-- Explication du calcul -->
        <div class="bg-white border border-violet-200 rounded-lg p-4 space-y-3">
          <p class="font-semibold text-gray-900 text-sm">üìå M√©thodologie du calcul</p>

          <div class="space-y-2 text-sm text-gray-700">
            <p>
              Cette projection s'appuie sur les <strong>naissances estim√©es √† l'horizon 2035</strong>
              (onglet ¬´ Population ¬ª, sc√©narios Stable √† -10%) :
              entre <strong><%= number_with_delimiter(local_assigns[:children_0_3_projection_2035][:births_minus_10]) %></strong> et
              <strong><%= number_with_delimiter(local_assigns[:children_0_3_projection_2035][:births_stable]) %></strong> naissances/an.
            </p>

            <div class="bg-violet-50 border border-violet-200 rounded p-3 mt-3">
              <p class="font-medium text-gray-900 mb-2">Trois √©tapes du calcul :</p>
              <ol class="list-decimal list-inside space-y-1 text-gray-700">
                <li>
                  <strong>Agr√©gation de 3 ann√©es</strong> :
                  Entre <%= number_with_delimiter(local_assigns[:children_0_3_projection_2035][:births_minus_10] * 3) %> et
                  <%= number_with_delimiter(local_assigns[:children_0_3_projection_2035][:births_stable] * 3) %> enfants
                </li>
                <li>
                  <strong>Correction mortalit√© infantile</strong> :
                  Taux de survie 99,65% (mortalit√© ~3,5 pour 1 000 en France) =
                  <strong>
                    entre <%= number_with_delimiter(local_assigns[:children_0_3_projection_2035][:minus_10]) %> et
                    <%= number_with_delimiter(local_assigns[:children_0_3_projection_2035][:stable]) %> enfants
                  </strong>
                </li>
                <li>
                  <strong>Hypoth√®se migration neutre</strong> :
                  Solde migratoire suppos√© nul (pas d'arriv√©e/d√©part net de jeunes familles)
                </li>
              </ol>
            </div>
          </div>

          <div class="bg-yellow-50 border border-yellow-200 rounded p-3 mt-3">
            <p class="text-xs text-gray-800">
              <strong>‚ö†Ô∏è Hypoth√®ses :</strong>
              Structure par √¢ge de la f√©condit√© stable ‚Ä¢ √Çge moyen √† la maternit√© ~31‚Äì32 ans
              ‚Ä¢ Solde migratoire neutre ‚Ä¢ La f√©condit√© r√©elle pourrait varier selon les tendances locales et r√©gionales.
            </p>
          </div>

          <p class="italic text-gray-600 border-l-2 border-violet-300 pl-3 mt-3">
            Cette projection permet d'<strong>anticiper les besoins en accueil du jeune enfant</strong>
            et d'ajuster progressivement les capacit√©s (cr√®ches, MAM, etc.) √† l'horizon 2035.
          </p>
        </div>
      </div>
    </div>
  </div>
  <% end %>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <!-- SECTION 3 : ENFANTS DE 3 √Ä 5 ANS -->
  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

  <div class="mt-8">
    <h3 class="text-sm font-medium text-gray-700 mb-4">
      üìç Enfants de 3 √† 5 ans
    </h3>
    <p class="text-xs text-gray-500 mb-4">
      <em>Hors p√©rim√®tre du Service Public de la Petite Enfance, mais indicateur compl√©mentaire de continuit√©</em>
    </p>
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Territoire
            </th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Part dans la population (%)
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <!-- Commune -->
          <tr>
            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
              <%= @territory_name %>
            </td>
            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
              <% commune_rate = @children_data&.dig("three_to_five_rate") || 0 %>
              <%= number_to_percentage(commune_rate, precision: 2) %>
            </td>
          </tr>

          <!-- EPCI -->
          <% if @epci_children_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 max-w-xs" title="<%= epci_display_name %>">
                <div class="truncate">
                  <%= display_territory_name(epci_display_name) %>
                </div>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <% epci_rate = @epci_children_data["three_to_five_rate"] rescue 0 %>
                <%= number_to_percentage(epci_rate, precision: 2) %>
              </td>
            </tr>
          <% end %>

          <!-- D√©partement -->
          <% if @department_children_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 max-w-xs" title="<%= department_display_name %>">
                <div class="truncate">
                  <%= display_territory_name(department_display_name) %>
                </div>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <% dept_rate = @department_children_data["three_to_five_rate"] rescue 0 %>
                <%= number_to_percentage(dept_rate, precision: 2) %>
              </td>
            </tr>
          <% end %>

          <!-- R√©gion -->
          <% if @region_children_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 max-w-xs" title="<%= region_display_name %>">
                <div class="truncate">
                  <%= display_territory_name(region_display_name) %>
                </div>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <% region_rate = @region_children_data["three_to_five_rate"] rescue 0 %>
                <%= number_to_percentage(region_rate, precision: 2) %>
              </td>
            </tr>
          <% end %>

          <!-- France -->
          <% if @france_children_data.present? %>
            <tr>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                France
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                <% france_rate = @france_children_data["three_to_five_rate"] rescue 0 %>
                <%= number_to_percentage(france_rate, precision: 2) %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

</div>
