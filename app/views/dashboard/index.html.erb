<!-- app/views/dashboard/index.html.erb -->
<div class="py-6">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-2xl font-semibold text-gray-900">Dashboard de <%= @territory_name %></h1>
      <span class="px-3 py-1 bg-indigo-100 text-indigo-800 rounded-full text-sm font-medium">
        Code INSEE: <%= @territory_code %>
      </span>
    </div>

    <!-- Carte de synthèse -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
      <h2 class="text-lg font-medium text-gray-900 mb-4">Synthèse démographique</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-indigo-50 p-4 rounded-lg">
          <h3 class="text-sm font-medium text-indigo-800 mb-1">Population totale</h3>
          <p class="text-2xl font-bold text-indigo-900">
            <%= number_with_delimiter(@total_population, delimiter: " ") %>
          </p>
        </div>
        <div class="bg-green-50 p-4 rounded-lg">
          <h3 class="text-sm font-medium text-green-800 mb-1">Enfants de moins de 3 ans</h3>
          <p class="text-2xl font-bold text-green-900">
            <%= number_with_delimiter(@children_data&.dig("children_under_3")&.round || 0) %>
          </p>
          <p class="text-sm text-green-600">
            <%= number_to_percentage(@children_data&.dig("under_3_rate") || 0, precision: 2) %> de la population
          </p>
        </div>
        <div class="bg-purple-50 p-4 rounded-lg">
          <h3 class="text-sm font-medium text-purple-800 mb-1">Enfants de 3 à 5 ans</h3>
          <p class="text-2xl font-bold text-purple-900">
            <%= number_with_delimiter(@children_data&.dig("children_3_to_5")&.round || 0) %>
          </p>
          <p class="text-sm text-purple-600">
            <%= number_to_percentage(@children_data&.dig("three_to_five_rate") || 0, precision: 2) %> de la population
          </p>
        </div>
      </div>
    </div>

    <!-- Graphique d'évolution historique -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
      <h2 class="text-lg font-medium text-gray-900 mb-4">Évolution démographique</h2>
      <div class="h-64">
        <canvas id="historical-chart"></canvas>
      </div>
    </div>

    <!-- Données économiques -->
    <div class="bg-white shadow rounded-lg p-6 mb-6">
      <h2 class="text-lg font-medium text-gray-900 mb-4">Indicateurs socio-économiques</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h3 class="text-sm font-medium text-gray-700 mb-2">Revenus médians (€)</h3>
          <table class="min-w-full divide-y divide-gray-200">
            <thead>
              <tr>
                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Année</th>
                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Montant</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <% @revenue_data&.dig("median_revenues")&.sort&.reverse&.each do |year, amount| %>
                <tr>
                  <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900"><%= year %></td>
                  <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                    <%= number_to_currency(amount, unit: "€", separator: ",", delimiter: " ", format: "%n %u") %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-700 mb-2">Taux de pauvreté (%)</h3>
          <table class="min-w-full divide-y divide-gray-200">
            <thead>
              <tr>
                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Année</th>
                <th class="px-4 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Taux</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <% @revenue_data&.dig("poverty_rates")&.sort&.reverse&.each do |year, rate| %>
                <tr>
                  <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900"><%= year %></td>
                  <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                    <%= number_to_percentage(rate, precision: 1) %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Éducation et petite enfance -->
    <div class="bg-white shadow rounded-lg p-6">
      <h2 class="text-lg font-medium text-gray-900 mb-4">Éducation et petite enfance</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h3 class="text-sm font-medium text-gray-700 mb-2">Taux de scolarisation (Année: <%= @schooling_data&.dig("data")&.keys&.sort&.last || "N/A" %>)</h3>
          <div class="space-y-4">
            <%
              latest_year = @schooling_data&.dig("data")&.keys&.sort&.last
              latest_data = @schooling_data&.dig("data", latest_year) if latest_year
            %>
            <div class="bg-yellow-50 p-4 rounded-md">
              <h4 class="font-medium text-yellow-800">Enfants de 2 ans</h4>
              <p class="text-xl font-bold text-yellow-900">
                <%= number_to_percentage(latest_data&.dig("schooling_rate_2y") || 0, precision: 1) %>
              </p>
              <p class="text-sm text-yellow-700">
                <%= number_with_delimiter(latest_data&.dig("schooled_children_2y") || 0) %>
                sur <%= number_with_delimiter(latest_data&.dig("total_children_2y") || 0) %> enfants
              </p>
            </div>
            <div class="bg-orange-50 p-4 rounded-md">
              <h4 class="font-medium text-orange-800">Enfants de 3 à 5 ans</h4>
              <p class="text-xl font-bold text-orange-900">
                <%= number_to_percentage(latest_data&.dig("schooling_rate_3_5y") || 0, precision: 1) %>
              </p>
              <p class="text-sm text-orange-700">
                <%= number_with_delimiter(latest_data&.dig("schooled_children_3_5y") || 0) %>
                sur <%= number_with_delimiter(latest_data&.dig("total_children_3_5y") || 0) %> enfants
              </p>
            </div>
          </div>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-700 mb-2">Modes d'accueil petite enfance</h3>
          <%
            latest_year = @childcare_data&.dig("coverage_data")&.keys&.sort&.last
            latest_childcare = @childcare_data&.dig("coverage_data", latest_year)&.dig("coverage_rates") if latest_year
          %>
          <% if latest_childcare %>
            <div class="space-y-2">
              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Accueil collectif</span>
                <span class="font-medium"><%= number_to_percentage(latest_childcare["eaje_total"] || 0, precision: 1) %></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="bg-blue-600 h-2.5 rounded-full" style="width: <%= latest_childcare["eaje_total"] || 0 %>%"></div>
              </div>

              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Assistantes maternelles</span>
                <span class="font-medium"><%= number_to_percentage(latest_childcare["childminder"] || 0, precision: 1) %></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="bg-green-600 h-2.5 rounded-full" style="width: <%= latest_childcare["childminder"] || 0 %>%"></div>
              </div>

              <div class="flex justify-between items-center">
                <span class="text-sm text-gray-600">Préscolarisation</span>
                <span class="font-medium"><%= number_to_percentage(latest_childcare["preschool"] || 0, precision: 1) %></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div class="bg-purple-600 h-2.5 rounded-full" style="width: <%= latest_childcare["preschool"] || 0 %>%"></div>
              </div>

              <div class="flex justify-between items-center mt-4">
                <span class="text-sm font-medium text-gray-700">Couverture globale</span>
                <span class="font-bold"><%= number_to_percentage(latest_childcare["global"] || 0, precision: 1) %></span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-3">
                <div class="bg-indigo-600 h-3 rounded-full" style="width: <%= latest_childcare["global"] || 0 %>%"></div>
              </div>
            </div>
          <% else %>
            <p class="text-gray-500 italic">Données non disponibles</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('turbo:load', function() {
  initHistoricalChart();
});

// Aussi écouter DOMContentLoaded pour le chargement initial
document.addEventListener('DOMContentLoaded', function() {
  initHistoricalChart();
});

function initHistoricalChart() {
  // Vérifier si Chart.js est chargé
  if (typeof Chart === 'undefined') {
    console.warn("Chart.js n'est pas chargé, attente...");
    setTimeout(initHistoricalChart, 100);
    return;
  }

  // Vérifier si ChartDataLabels est chargé
  if (typeof ChartDataLabels === 'undefined') {
    try {
      // Essayer d'enregistrer le plugin s'il est disponible globalement
      Chart.register(window.ChartDataLabels);
    } catch (e) {
      console.warn("ChartDataLabels n'est pas disponible", e);
    }
  } else {
    Chart.register(ChartDataLabels);
  }

  // Vérifier si l'élément canvas existe
  const chartElement = document.getElementById('historical-chart');
  const historicalData = <%= raw (@historical_data || []).to_json %>;

  if (!chartElement) {
    console.warn("Élément canvas non trouvé");
    return;
  }

  if (!historicalData || historicalData.length === 0) {
    console.warn("Données historiques non disponibles");
    return;
  }

  // Vérifier si un graphique existe déjà sur ce canvas
  const existingChart = Chart.getChart(chartElement);
  if (existingChart) {
    existingChart.destroy();
  }

  // Le reste de votre code pour créer le graphique...
  const years = ['1968', '1975', '1982', '1990', '1999', '2010', '2015', '2021'];
  const populations = years.map(year => {
    const yearKey = year === '1968' ? 'D68_POP' :
                    year === '1975' ? 'D75_POP' :
                    year === '1982' ? 'D82_POP' :
                    year === '1990' ? 'D90_POP' :
                    year === '1999' ? 'D99_POP' :
                    year === '2010' ? 'P10_POP' :
                    year === '2015' ? 'P15_POP' : 'P21_POP';
    return historicalData[0]?.[yearKey] || 0;
  });

  // Créer le graphique
  new Chart(chartElement, {
    type: 'line',
    data: {
      labels: years,
      datasets: [{
        label: 'Population',
        data: populations,
        backgroundColor: 'rgba(79, 70, 229, 0.2)',
        borderColor: 'rgba(79, 70, 229, 1)',
        borderWidth: 2,
        tension: 0.1,
        pointBackgroundColor: 'rgba(79, 70, 229, 1)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: false,
          ticks: {
            callback: function(value) {
              return new Intl.NumberFormat('fr-FR').format(value);
            }
          }
        }
      },
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'Population: ' + new Intl.NumberFormat('fr-FR').format(context.raw);
            }
          }
        },
        datalabels: {
          align: 'top',
          anchor: 'end',
          formatter: function(value) {
            return new Intl.NumberFormat('fr-FR').format(value);
          },
          font: {
            weight: 'bold',
            size: 10
          },
          color: '#4F46E5',
          padding: {
            top: 10
          }
        }
      }
    }
  });

  console.log("Graphique créé avec succès");
}
</script>
