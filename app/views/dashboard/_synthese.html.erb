<!-- app/views/dashboard/_synthese.html.erb -->
<!-- Synth√®se d√©mographique -->
<div class="bg-white shadow rounded-lg p-6 mb-6">
  <h2 class="text-lg font-medium text-gray-900 mb-4">Synth√®se d√©mographique</h2>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="bg-indigo-50 p-4 rounded-lg">
      <h3 class="text-sm font-medium text-indigo-800 mb-1">Population totale</h3>
      <p class="text-2xl font-bold text-indigo-900">
        <%= number_with_delimiter(total_population, delimiter: " ") %>
      </p>
    </div>
    <div class="bg-green-50 p-4 rounded-lg">
      <h3 class="text-sm font-medium text-green-800 mb-1">Enfants de moins de 3 ans</h3>
      <p class="text-2xl font-bold text-green-900">
        <%= number_with_delimiter(population_data&.select { |item| item["AGED100"].to_i < 3 }&.sum { |item| item["NB"].to_f }&.round || 0) %>
      </p>
      <p class="text-sm text-green-600">
        <% under_3_count = population_data&.select { |item| item["AGED100"].to_i < 3 }&.sum { |item| item["NB"].to_f } || 0 %>
        <% under_3_rate = total_population > 0 ? (under_3_count / total_population) * 100 : 0 %>
        <%= number_to_percentage(under_3_rate, precision: 2) %> de la population
      </p>
    </div>
    <div class="bg-purple-50 p-4 rounded-lg">
      <h3 class="text-sm font-medium text-purple-800 mb-1">Enfants de 3 √† 5 ans</h3>
      <p class="text-2xl font-bold text-purple-900">
        <%= number_with_delimiter(population_data&.select { |item| (3..5).include?(item["AGED100"].to_i) }&.sum { |item| item["NB"].to_f }&.round || 0) %>
      </p>
      <p class="text-sm text-purple-600">
        <% three_to_five_count = population_data&.select { |item| (3..5).include?(item["AGED100"].to_i) }&.sum { |item| item["NB"].to_f } || 0 %>
        <% three_to_five_rate = total_population > 0 ? (three_to_five_count / total_population) * 100 : 0 %>
        <%= number_to_percentage(three_to_five_rate, precision: 2) %> de la population
      </p>
    </div>
  </div>

  <!-- Section pour la pyramide des √¢ges -->
  <div class="mt-6">
    <h3 class="text-sm font-medium text-gray-700 mb-4">Pyramide des √¢ges</h3>
    <div class="h-96">
      <canvas id="age-pyramid-chart"></canvas>
    </div>
  </div>
</div>

<!-- Bloc contextuel : Lecture de la pyramide des √¢ges et petite enfance -->
<div class="mt-6 bg-gradient-to-r from-sky-50 to-blue-50 border-l-4 border-sky-500 rounded-lg p-6 shadow-sm">
  <div class="flex items-start space-x-4">
    <!-- Ic√¥ne -->
    <div class="flex-shrink-0">
      <div class="p-3 bg-sky-100 rounded-lg">
        <svg class="w-6 h-6 text-sky-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
      </div>
    </div>

    <!-- Contenu -->
    <div class="flex-1">
      <h4 class="text-lg font-semibold text-gray-900 mb-3">
        üìä Lecture du tableau ‚Äì Pyramide des √¢ges et petite enfance
      </h4>

      <div class="space-y-4 text-sm text-gray-700 leading-relaxed">

        <!-- Section 1: Introduction -->
        <div>
          <p class="font-semibold text-gray-800 mb-2">Un outil d'analyse locale essentiel</p>
          <p>
            La pyramide des √¢ges constitue le <strong>premier niveau d'analyse d√©mographique</strong> d'une commune.
            Elle offre une photographie instantan√©e de la r√©partition de la population par √¢ge et permet d'observer
            la forme de la base, r√©v√©latrice du poids des jeunes enfants et des familles en √¢ge d'avoir des enfants.
            Cet indicateur, bien que statique, constitue une entr√©e pr√©cieuse pour comprendre les tendances locales
            avant d'analyser plus finement les naissances, les enfants de 0‚Äì3 ans et les besoins en modes de garde.
          </p>
        </div>

        <!-- Section 2: Lecture pour la politique communale -->
        <div class="bg-white border border-sky-200 rounded-lg p-4">
          <p class="font-semibold text-gray-900 mb-2">üîç Lecture pour la politique communale de la petite enfance</p>
          <p>
            Pour une commune, la structure des <strong>jeunes adultes (20‚Äì40 ans)</strong> et de la base de la pyramide
            renseigne sur le <strong>potentiel de naissances √† venir</strong> et sur la pression future sur les modes d'accueil.
            Elle permet d'orienter la planification des cr√®ches, relais petite enfance ou accueils familiaux,
            en coh√©rence avec les besoins des familles du territoire.
          </p>
        </div>

        <!-- Section 3: Interpr√©tation de la forme -->
        <div>
          <p class="font-semibold text-gray-800 mb-2">üìà Interpr√©tation de la forme de la base</p>
          <ul class="space-y-2 ml-4">
            <li class="flex items-start space-x-2">
              <span class="text-sky-600 font-bold">‚ñ∏</span>
              <span><strong>Une base large</strong> traduit une commune jeune et attractive, appelant √† renforcer les capacit√©s d'accueil et les services aux familles.</span>
            </li>
            <li class="flex items-start space-x-2">
              <span class="text-sky-600 font-bold">‚ñ∏</span>
              <span><strong>Une base √©troite</strong> signale au contraire un vieillissement de la population et la n√©cessit√© d'adapter l'offre existante tout en attirant de jeunes m√©nages (logement, emploi, services √† la famille).</span>
            </li>
          </ul>
        </div>

        <!-- Section 4: Conclusion -->
        <div class="bg-indigo-50 border-l-2 border-indigo-300 pl-4 py-2">
          <p>
            La pyramide des √¢ges constitue ainsi un <strong>rep√®re cl√© pour anticiper les √©volutions locales</strong>
            et ajuster les politiques communales de la petite enfance et de l'attractivit√© r√©sidentielle.
          </p>
        </div>

        <!-- Sources -->
        <div class="text-xs text-gray-600 pt-2 border-t border-sky-200">
          <p><strong>Sources :</strong> INSEE (2023) ‚Ä¢ Futuribles, ¬´ D√©mographie : des EHPAD ou des cr√®ches ? ¬ª (2024)</p>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Graphique d'√©volution historique -->
<% if historical_data.present? %>

  <!-- Section 1: √âvolution de la population -->
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4">√âvolution de la population</h2>
    <div class="h-64">
      <canvas id="historical-chart"></canvas>
    </div>
  </div>

  <!-- Bloc explicatif: Lecture du graphique population -->
  <div class="bg-gradient-to-r from-amber-50 to-orange-50 border-l-4 border-amber-500 rounded-lg p-6 mb-6 shadow-sm">
    <div class="flex items-start space-x-4">
      <!-- Ic√¥ne -->
      <div class="flex-shrink-0">
        <div class="p-3 bg-amber-100 rounded-lg">
          <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
        </div>
      </div>

      <!-- Contenu -->
      <div class="flex-1">
        <h4 class="text-lg font-semibold text-gray-900 mb-3">
          üìà Lecture du graphique ‚Äì √âvolution de la population communale et dynamiques locales
        </h4>

        <div class="space-y-4 text-sm text-gray-700 leading-relaxed">

          <!-- Section 1: Introduction -->
          <div>
            <p>
              L'√©volution de la population d'une commune refl√®te ses <strong>grandes tendances d√©mographiques</strong> :
              une hausse traduit souvent une <strong>attractivit√© r√©sidentielle</strong> li√©e √† l'installation de nouveaux habitants,
              tandis qu'une stagnation ou une baisse peut indiquer un vieillissement de la population ou un recul des naissances.
            </p>
          </div>

          <!-- Section 2: Attention croissance vs naissances -->
          <div class="bg-white border-l-4 border-amber-300 rounded-lg p-4">
            <p class="font-semibold text-gray-900 mb-2">‚ö†Ô∏è Croissance ‚â† Hausse des naissances</p>
            <p class="mb-2">
              Une croissance de la population ne signifie pas toujours une augmentation des naissances :
              dans de nombreuses communes, la hausse est port√©e avant tout par les <strong>migrations r√©sidentielles</strong>
              (arriv√©e de jeunes m√©nages, retrait√©s, etc.) plut√¥t que par un rebond de la f√©condit√©.
            </p>
            <p>
              √Ä l'inverse, la <strong>baisse nationale des naissances</strong> observ√©e depuis plusieurs ann√©es
              peut r√©duire progressivement la part des jeunes enfants, m√™me dans des communes encore en expansion d√©mographique.
            </p>
          </div>

          <!-- Section 3: √Ä retenir -->
          <div class="bg-blue-50 border-l-2 border-blue-300 pl-4 py-3 rounded">
            <p class="font-semibold text-gray-900 mb-2">üëâ √Ä retenir :</p>
            <p>
              Pour une lecture fine, il est essentiel de <strong>croiser l'√©volution de la population totale
              avec la courbe des naissances</strong> (onglet ¬´ Naissances ¬ª). Cela permet d'identifier si la croissance
              est port√©e par les mouvements de population ou par le dynamisme naturel du territoire,
              et d'en d√©duire les besoins futurs en accueil du jeune enfant et en services aux familles.
            </p>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Section 2: √âvolution des naissances -->
  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <h2 class="text-lg font-medium text-gray-900 mb-4">√âvolution des naissances</h2>
    <div class="h-64">
      <canvas id="births-chart"></canvas>
    </div>
  </div>

  <!-- Bloc explicatif: Contexte d√©mographique et naissances -->
  <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-l-4 border-green-500 rounded-lg p-6 mb-6 shadow-sm">
    <div class="flex items-start space-x-4">
      <!-- Ic√¥ne -->
      <div class="flex-shrink-0">
        <div class="p-3 bg-green-100 rounded-lg">
          <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
          </svg>
        </div>
      </div>

      <!-- Contenu -->
      <div class="flex-1">
        <h4 class="text-lg font-semibold text-gray-900 mb-3">
          üìä Contexte d√©mographique communal : √©volution des naissances et perspectives
        </h4>

        <div class="space-y-4 text-sm text-gray-700 leading-relaxed">

          <!-- Section 1: Lecture du tableau -->
          <div>
            <p class="font-semibold text-gray-800 mb-2">Lecture du tableau</p>
            <p class="mb-2">
              La baisse du nombre de naissances observ√©e depuis plusieurs ann√©es s'inscrit dans une
              <strong>tendance nationale durable de recul de la f√©condit√©</strong>. Selon l'INED
              (Population & Soci√©t√©s, n¬∞635, 2025), l'indicateur conjoncturel de f√©condit√© est pass√©
              de <strong>2,0 enfants par femme en 2014 √† 1,6 en 2024</strong>, soit une baisse de pr√®s de 20 %.
            </p>
            <p>
              √Ä l'√©chelle communale, cette √©volution se traduit souvent par un <strong>ralentissement du nombre
              d'enfants de moins de 3 ans</strong>, mais avec des disparit√©s fortes selon les quartiers ou IRIS :
              certaines zones peuvent accueillir davantage de jeunes m√©nages, tandis que d'autres se vieillissent
              plus rapidement. Ces contrastes locaux <strong>influencent directement les besoins en modes d'accueil</strong>.
            </p>
          </div>

          <!-- Section 2: Implications -->
          <div class="bg-white border border-green-200 rounded-lg p-4">
            <p class="font-semibold text-gray-900 mb-3">üí° Implications pour la politique communale de la petite enfance :</p>
            <ul class="space-y-2">
              <li class="flex items-start space-x-3">
                <span class="text-green-600 font-bold mt-0.5">‚Ä¢</span>
                <span>
                  <strong>Anticiper une natalit√© plus faible et plus tardive</strong>, tout en maintenant une offre d'accueil
                  de qualit√© et de proximit√©.
                </span>
              </li>
              <li class="flex items-start space-x-3">
                <span class="text-green-600 font-bold mt-0.5">‚Ä¢</span>
                <span>
                  <strong>D√©velopper une analyse fine par IRIS</strong> pour rep√©rer les secteurs o√π la demande reste soutenue
                  et ceux o√π elle diminue.
                </span>
              </li>
              <li class="flex items-start space-x-3">
                <span class="text-green-600 font-bold mt-0.5">‚Ä¢</span>
                <span>
                  <strong>Ajuster la localisation et la capacit√© des structures</strong> (cr√®ches, MAM, assistantes maternelles)
                  afin de garantir une √©galit√© d'acc√®s pour toutes les familles.
                </span>
              </li>
            </ul>
          </div>

          <!-- Section 3: Conclusion -->
          <div class="bg-emerald-50 border-l-2 border-emerald-400 pl-4 py-3 rounded">
            <p>
              La lecture des naissances par IRIS permet ainsi d'<strong>orienter la planification communale</strong> :
              adapter l'offre l√† o√π les besoins persistent, soutenir les quartiers attractifs pour les jeunes m√©nages
              et pr√©venir les d√©s√©quilibres territoriaux.
            </p>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- üÜï BLOC : Projection des naissances 2035 (sc√©nario ICF 1,6) -->
  <% if local_assigns[:women_15_49].present? && local_assigns[:women_15_49] > 0 %>
  <div class="mt-8 bg-gradient-to-r from-rose-50 to-pink-50 border-l-4 border-rose-500 rounded-lg p-6 shadow-sm">
    <div class="flex items-start space-x-4">
      <!-- Ic√¥ne -->
      <div class="flex-shrink-0">
        <div class="p-3 bg-rose-100 rounded-lg">
          <svg class="w-6 h-6 text-rose-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
      </div>

      <!-- Contenu -->
      <div class="flex-1">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
          üìà Projection des naissances en 2035 (sc√©nario ICF 1,6)
        </h3>

        <!-- 3 cartes KPI -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
          <!-- Femmes 15-49 ans -->
          <div class="bg-white rounded-lg p-4 border border-rose-200">
            <p class="text-sm text-gray-600 font-medium mb-1">Femmes 15‚Äì49 ans (2024)</p>
            <p class="text-3xl font-bold text-rose-700">
              <%= number_with_delimiter(local_assigns[:women_15_49], delimiter: " ") %>
            </p>
            <p class="text-xs text-gray-500 mt-2">Population fertile</p>
          </div>

          <!-- Projection naissances -->
          <div class="bg-white rounded-lg p-4 border border-rose-200">
            <p class="text-sm text-gray-600 font-medium mb-1">Naissances estim√©es en 2035</p>
            <p class="text-3xl font-bold text-pink-700">
              <%= number_with_delimiter(local_assigns[:births_projection_2035], delimiter: " ") %>
            </p>
            <p class="text-xs text-gray-500 mt-2">Avec ICF constant √† 1,6</p>
          </div>

          <!-- Ratio femmes/naissances -->
          <div class="bg-white rounded-lg p-4 border border-rose-200">
            <p class="text-sm text-gray-600 font-medium mb-1">Moyenne naissances par femme</p>
            <p class="text-3xl font-bold text-red-700">
              <%= number_with_precision(1.6, precision: 2) %>
            </p>
            <p class="text-xs text-gray-500 mt-2">Indice Conjoncturel de F√©condit√© (ICF)</p>
          </div>
        </div>

        <!-- üÜï Graphique de projection -->
        <% if local_assigns[:births_projection_data].present? && local_assigns[:births_projection_data][:projection_years].present? %>
        <div class="mb-6 bg-white rounded-lg p-6 border border-rose-200 shadow-sm">
          <h4 class="text-lg font-semibold text-gray-900 mb-4">√âvolution et projection des naissances jusqu'en 2035</h4>
          <div class="h-96">
            <canvas id="commune-births-projection-chart"></canvas>
          </div>
          <p class="text-xs text-gray-500 mt-3 text-center">
            Historique + projection jusqu'en 2035 ‚Ä¢ Trois sc√©narios d'ICF (1,5 ‚Äì 1,6 ‚Äì 1,7)
          </p>
        </div>
        <% end %>

        <!-- Donn√©es JSON pour le graphique de projection -->
        <% if local_assigns[:births_projection_data].present? %>
        <script type="application/json" id="commune-births-projection-data">
          {
            "historical_years": <%= raw(local_assigns[:births_projection_data][:historical_years].to_json) %>,
            "historical_values": <%= raw(local_assigns[:births_projection_data][:historical_values].to_json) %>,
            "projection_years": <%= raw(local_assigns[:births_projection_data][:projection_years].to_json) %>,
            "projection_values_low": <%= raw(local_assigns[:births_projection_data][:projection_values_low].to_json) %>,
            "projection_values_central": <%= raw(local_assigns[:births_projection_data][:projection_values_central].to_json) %>,
            "projection_values_high": <%= raw(local_assigns[:births_projection_data][:projection_values_high].to_json) %>,
            "target_low": <%= local_assigns[:births_projection_data][:target_low] %>,
            "target_central": <%= local_assigns[:births_projection_data][:target_central] %>,
            "target_high": <%= local_assigns[:births_projection_data][:target_high] %>
          }
        </script>
        <% end %>

        <!-- Explication -->
        <div class="bg-white border border-rose-200 rounded-lg p-4 space-y-3">
          <div>
            <p class="font-semibold text-gray-900 text-sm mb-2">üìå M√©thodologie</p>
            <p class="text-sm text-gray-700 leading-relaxed">
              Cette projection s'appuie sur la structure actuelle des femmes en √¢ge de procr√©er (15‚Äì49 ans) de votre commune
              et un sc√©nario d'<strong>ICF constant √† 1,6 enfant par femme</strong> jusqu'en 2035.
              Cet indicateur repr√©sente un sc√©nario de <strong>f√©condit√© basse</strong>, contrastant avec le sc√©nario central INSEE
              (ICF √† 1,8) qui anticiperait environ <strong>11 % de naissances suppl√©mentaires</strong>.
            </p>
          </div>

          <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
            <p class="text-xs text-gray-800">
              <strong>‚ö†Ô∏è Hypoth√®ses :</strong>
              Structure par √¢ge de la f√©condit√© stable ‚Ä¢ √Çge moyen √† la maternit√© ~31‚Äì32 ans
              ‚Ä¢ Solde migratoire neutre ‚Ä¢ La f√©condit√© r√©elle pourrait varier selon les tendances locales et r√©gionales.
            </p>
          </div>

          <div class="italic text-sm text-gray-600 border-l-2 border-rose-300 pl-3">
            <strong>Sources :</strong> INSEE (2024) ‚Ä¢ INED, Population & Soci√©t√©s n¬∞635 (2025)
          </div>
        </div>
      </div>
    </div>
  </div>
  <% end %>
<% end %>

<!-- Donn√©es JSON pour les graphiques (OBLIGATOIRE) -->
<script type="application/json" id="population-data-json">
<%= raw(population_data.to_json) %>
</script>

<script type="application/json" id="historical-data">
<%= raw(historical_data.to_json) %>
</script>

<script type="application/json" id="births-data-filtered">
<%= raw(births_data_filtered.to_json) %>
</script>

<!-- SUPPRESSION DU SCRIPT INLINE - Les graphiques sont maintenant g√©r√©s par charts_init.js -->
